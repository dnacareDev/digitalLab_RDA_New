<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- 파비콘 -->
<link rel="icon" href="/favicon.ico">
<!-- <link rel="icon" href="../../static/favicon.ico"> -->
<title>Digital Lab - 실험 방법</title>
<link rel="stylesheet" href="/css/common/reset.css">
<link rel="stylesheet" href="/css/common/common.css">
<link rel="stylesheet" href="/css/common/ui.css">
<link rel="stylesheet" href="/css/style/harvesting_after.css">
<link rel="stylesheet" href="/css/style/new_enrollment.css">
<link rel="stylesheet" href="/toastGrid/tui-grid.min.css" />
<link rel="stylesheet" href="/toastGrid/tui-pagination.css" />

<script src="/js/common/jquery-3.6.0.js"></script>
<script src="/js/common/loadHeader.js"></script>
<script src="/js/common/common.js"></script>


<!-- <link rel="stylesheet" href="../../static/css/common/reset.css">
<link rel="stylesheet" href="../../static/css/common/common.css">
<link rel="stylesheet" href="../../static/css/common/ui.css">
<link rel="stylesheet" href="../../static/css/style/harvesting_after.css">
<link rel="stylesheet" href="../../static/css/style/new_enrollment.css">
<link rel="stylesheet" href="../../static/toastGrid/tui-grid.min.css" />
<link rel="stylesheet" href="../../static/toastGrid/tui-pagination.css" />

<script src="../../static/js/common/jquery-3.6.0.js"></script>
<script src="../../static/js/common/loadHeader.js"></script>
<script src="../../static/js/common/common.js"></script> -->
</head>
<body>
	<div id="wrap">
		<!-- 공통 구조 - header -->
		<div id="header">
			<th:block th:include="/../header/header.html"></th:block>
		</div>
		<!-- 공통 구조 - header end -->

		<!-- 공통 구조 - main -->
		<main id="main">
			<!-- 공통 구조 - main_header -->
			<th:block th:include="/../header/main_header.html"></th:block>
			<!-- 공통 구조 - main_header end-->

			<!-- 공통 구조 - quick menu -->
            <th:block th:include="/../header/quick_menu.html"></th:block>
            <!-- 공통 구조 - quick menu end -->

			<section class="card_box harvesting_sect new_enroll_sect">
				<div class="card_title_box">
					<h2 class="card_title">실험 방법</h2>
					<ul class="card_list_text">
						<li class="card_top_list">재료 및 방법 -</li>
						<li class="card_inner_list">실험 방법 -</li>
						<li class="card_inner_list">탬플릿 등록</li>
					</ul>
					<div class="print_box">
						<button class="common_btn1">변경 이력</button>
					</div>
				</div>
				<div class="method_sharing">
					<select id="share_select_box" class="work_step_select common_select">
						<option value="1" selected>그룹공유</option>
						<option value="2">공유안함</option>
					</select>
				</div>
				<div class="card">
					<div class="card_cont_box">
						<span class="error_text">사용중인 메소드로 인해 삭제가 불가합니다.</span>
						<form id="methodForm" action=""
							class="new_enroll_form common_form">
							<div class="first_enroll_box">
								<div class="form_box lookup_box look_m_box">
									<label for="list_lookup" class="file_title">분석 항목</label>
									<div class="lookup_input form_inner_box">
										<input type="text" id="list_lookup" readonly="readonly"><button type="button"
											class=" form_btn list_lookup_btn modal_on_btn common_btn1"
											data-modal="_lookup">항목 조회</button>
									</div>
								</div>
								<div class="form_box lookup_box select_box">
									<label for="work_step" class="file_title">작업 단계</label> <select
										name="method_stage" id="work_step"
										class="work_step_select common_select">
										<option value="-1" hidden>작업 단계 선택</option>
										<option value="1">전처리</option>
										<option value="2">시료분석</option>
									</select>
								</div>
							</div>
							<div class="form_box explane_box explane_m_box">
								<label for="method_explane" class="file_title">실험방법 설명</label>
								<textarea name="method_contents" id="method_contents"
									class="method_explane_box"></textarea>
							</div>
							
							<input type="hidden" name="division_depth_id_1" id="division_depth_id_1">
							<input type="hidden" name="division_depth_id_2" id="division_depth_id_2">
							<input type="hidden" name="division_parents" id="division_parents">
							<input type="hidden" name="division_id" id="division_id">

							<input type="hidden" name="division_1" id="division_1">
							<input type="hidden" name="division_2" id="division_2">
							<input type="hidden" name="division_3" id="division_3">
							<input type="hidden" name="division" id="division">
							
							<input type="hidden" name="method_share" value="1"/>
							<input type="hidden" name="template_head" />
							<input type="hidden" name="template_body" />
						</form>
					</div>
				</div>
				<div class="card">
					<div class="card_cont_box harvesting_add_box">
						<form action="" class="harvesting_form common_form">
							<div class="form_box file_box">
								<span class="file_title">파일 선택</span>
								<div class="file_input form_inner_box">
									<input type="text" class="file_name" readonly><input
										type="file" name="excelFile" id="file_select2"
										class="file_select_input" data-none="false" accept=".xlsx , .xls"><label
										for="file_select2" class="form_btn common_btn1">파일 선택</label>
								</div>
								<span class="ex_text"><span class="star">* </span> 엑셀 파일만
									등록 가능합니다</span>
							</div>
						</form>
						<div class="card_sect_footer">
							<button class="common_btn1 template_btn">탬플릿등록</button>
						</div>
					</div>
				</div>

				<div id="gridView" class="card save_table_card_" style="display: none">
					<div class="card_cont_box">
						<div id="grid"></div>
					</div>
				</div>

				<div class="card_footer">
					<button type="button" class="list_btn common_btn1">목록</button>
					<button type="button" class="save_btn common_btn1"
						onclick="onClickRegist();">등록</button>
				</div>
			</section>

			<!-- 분석 항목 모달 -->
			<div class="modal lookup_modal" id="_lookup">
				<div class="modal_box on">
					<div class="modal_header">
						<h2 class="modal_title">분석 항목 조회</h2>
						<button class="modal_close">닫기</button>
					</div>
					<form action="" class="modal_form common_form lookup_form">

						<!-- depth_1 -->
						<div class="select_box modal_input_box">
							<label for="" class="modal_form_title">용도</label> <select class="common_select"
								id="modal_division_1" onchange="onChangeDivisionDepth1()">
								<option value="-1" hidden>용도 선택</option>
								<th:block th:each="list : ${result.list}">
									<option th:value="${list.division_id}" th:text="${list.division}"></option>
								</th:block>
								<option value="-2">신규등록</option>
							</select>
						</div>
						<div class="select_box modal_input_box off" id="new_item_div_1">
							<label for="" class="modal_form_title">신규 세부 항목</label><input type="text"
								id="new_item_input_1" class="">
						</div>

						<!-- depth_2 -->
						<div class="select_box modal_input_box">
							<label for="" class="modal_form_title">분류</label> <select class="common_select"
								id="modal_division_2" onchange="onChangeDivisionDepth2()">
								<option value="-1" hidden>분류 선택</option>
							</select>
						</div>
						<div class="select_box modal_input_box off" id="new_item_div_2">
							<label for="" class="modal_form_title">신규 세부 항목</label><input type="text"
								id="new_item_input_2" class="">
						</div>

						<!-- depth_3 -->
						<div class="select_box modal_input_box">
							<label for="" class="modal_form_title">분석 항목</label> <select class="common_select"
								id="modal_division_parent" onchange="onChangeDivisionDepth3()">
								<option value="-1" hidden>분석 항목 선택</option>
							</select>
						</div>
						<div class="select_box modal_input_box off" id="new_item_div_3">
							<label for="" class="modal_form_title">신규 세부 항목</label><input type="text"
								id="new_item_input_3" class="">
						</div>

						<!-- depth_4 -->
						<div class="select_box modal_input_box">
							<label for="" class="modal_form_title">세부 항목</label> <select class="common_select"
								id="detail_select" onchange="onChangeDetailSelect()">
								<option value="-1" hidden>세부 항목 선택</option>
							</select>
						</div>
						<div class="select_box modal_input_box off" id="new_item_div_4">
							<label for="" class="modal_form_title">신규 세부 항목</label><input type="text"
								id="new_item_input_4" onkeyup="onKeyupNewItemInput()" class="">
						</div>
					</form>
					<div class="modal_footer">
						<button class="common_btn1 modal_btn off" id="_lookup_btn" onclick="onClickModalUse()"
							data-dismiss="_lookup">사용</button>
					</div>
				</div>
			</div>

			<!-- 모달 -->
			<div class="modal lookup_modal" id="kindSelect">
				<div class="modal_box on">
					<div class="modal_header">
						<h2 class="modal_title">분석 항목 조회</h2>
						<button class="modal_close">닫기</button>
					</div>
					<form action="" class="modal_form common_form lookup_form">
						<div class="select_box modal_input_box">
							<p for="" class="modal_form_title">품종/유전정보</p>
							<div class="raido_box_wrap">
								<div class="radio_box">
									<input type="radio" name="kindInfo" id="_kind"> <label
										for="_kind"></label>
								</div>
								<div class="radio_box">
									<input type="radio" name="kindInfo" id="_genetic"> <label
										for="_genetic"></label>
								</div>
								<div class="radio_box">
									<input type="radio" name="kindInfo" id="_etc"> <label
										for="_etc"></label>
								</div>
							</div>
						</div>
						<div class="select_box modal_input_box">
							<label for="" class="modal_form_title">용도</label> <select
								class="common_select" id="">
								<option value="" hidden>용도 선택</option>
								<option value="">기능성</option>
							</select>
						</div>
						<div class="select_box modal_input_box">
							<label for="" class="modal_form_title">분류</label> <select
								class="common_select" id="">
								<option value="" hidden>용도 선택</option>
								<option value="">기능성 관련 성분</option>
							</select>
						</div>
						<div class="form_box modal_input_box off">
							<label for="" class="modal_form_title">신규 세부 항목</label> <input
								type="text" id="" class="">
						</div>
					</form>
					<div class="modal_footer">
						<button class="common_btn1 modal_btn off">사용</button>
					</div>
				</div>
			</div>
		</main>
		<!-- 공통 구조 - main end -->
	</div>

	<script src="/toastGrid//tui-pagination.js"></script>
	<script src="/toastGrid//tui-grid.min.js"></script>

	<script>
	// toast- grid
	let coldata = [{},{},{},{},{},{},{},{}];
	let rowdata = [{},{},{},{},{}];
	let checkRow = [];
	let rowLength;
	
	// row key
	let rowKey = 4;
	
	const Grid = tui.Grid;
	let instance;

	function grid(){
		
	$('#gridView').css('display' , '');	
		
	instance = new Grid({
		el : document.getElementById('grid'), // Container element
		minBodyHeight : 5,
		scrollX : false,
		scrollY : false,
		rowHeaders : [ 'rowNum' ],
		data : rowdata,
		columns : coldata
		});
	
		//instance.resetData(newData); // Call API of instance's public method
		Grid.applyTheme('clean'); // Call API of static method
	}

	
		// 엑셀 불러오기
		$('.template_btn').on('click', function(){
			
			$("#grid").children().remove();
			
			var formData = new FormData();
			
			let excelFile = $('input[name="excelFile"]')[0];
			
			if(excelFile.files.length <= 0){
				alert("파일을 선택해주세요.");
				return;
			}
			
			for (var i=0; i<excelFile.files.length; i++) {
				formData.append("excelFile", excelFile.files[i]);
			}

			for (var key of formData.keys()) {
				console.log(key);
			}
			
			for (var value of formData.values()) {
				console.log(value);
			}
			
			$.ajax({
				type : "POST",
				enctype : "multipart/form-data",
				url : "/api/method_excel_add",
				data : formData,
				processData : false,
				contentType : false,
				success : function(data) {
					
					coldata = [];
	                
	                for(let i of data.head){
	                	
	                	let obj = { header: `${i.header}`,
	                        		name: `${i.name}`,
	                       			 editor: 'text'
	                     		 }
	                	coldata.push(obj);
	                }
	                rowdata = data.body;
	                grid();
				},
				error : function(err) {
					alert("엑셀 등록에 실패했습니다. 관리자에게 문의해주세요.");
				}
			});
		})
		
		$('#share_select_box').on('change' , function(e){
			$('input[name="method_share"]').val(e.target.value);
		})
		
		// 분석항목 등록
		function onClickModalUse(){
			
			let divisionDepth1 = $('#modal_division_1').val();
			let divisionDepth2 = $('#modal_division_2').val();
			let divisionParent = $('#modal_division_parent').val();
			let division_id = $('#detail_select').val();

			let division_1 = $('#new_item_input_1').val();
			let division_2 = $('#new_item_input_2').val();
			let division_3 = $('#new_item_input_3').val();
			let division_4 = $('#new_item_input_4').val();

			if (divisionDepth1 == -2 && division_1 == '') {
				alert('신규 세부 항목을 입력해주세요');
				return;
			}
			if (divisionDepth2 == -2 && division_2 == '') {
				alert('신규 세부 항목을 입력해주세요');
				return;
			}
			if (divisionParent == -2 && division_3 == '') {
				alert('신규 세부 항목을 입력해주세요');
				return;
			}
			if (division_id == -2 && division_4 == '') {
				alert('신규 세부 항목을 입력해주세요');
				return;
			}
			
			if(division_id == -1 || division_id == ''){
				alert("분석 항목을 입력해주세요")
				return;
			}

			// 신규 아이디 값
			$('#division_depth_id_1').val(divisionDepth1);
			$('#division_depth_id_2').val(divisionDepth2);
			$('#division_parents').val(divisionParent);
			$('#division_id').val(division_id);

			// 신규 텍스트
			$('#division_1').val(division_1);
			$('#division_2').val(division_2);
			$('#division_3').val(division_3);
			$('#division').val(division_4);

			let depth_text_1 = '';
			let depth_text_2 = '';
			let depth_text_3 = '';
			let depth_text_4 = '';

			if (divisionDepth1 == -2) {
				depth_text_1 = division_1;
			} else {
				depth_text_1 = $('#modal_division_1 option:selected').text();
			}

			if (divisionDepth2 == -2) {
				depth_text_2 = division_2;
			} else {
				depth_text_2 = $('#modal_division_2 option:selected').text();
			}

			if (divisionParent == -2) {
				depth_text_3 = division_3;
			} else {
				depth_text_3 = $('#modal_division_parent option:selected').text();
			}

			depth_text_4 = division_4;

			let text = depth_text_1 + " > " + depth_text_2 + " > " + depth_text_3 + " > " + depth_text_4;
			$('#list_lookup').val(text);
			$('#_lookup').removeClass('on');
			$('#main').removeClass('modal_on');
        }
		
		
		function initSelect(id, text, isDetail){
            $('#' + id).empty();
            let defaultOption = `<option value="-1" hidden>${text}</option>`
            $('#' + id).append(defaultOption);
            $('#' + id).val(-1).prop("selected","true");

            if(isDetail){
                let newItem = `<option value="-2">신규 등록</option>`
                $('#' + id).append(newItem);
            }
        }

        function initDivisionSelect(depth){
            switch (depth){
                case 1: initSelect('modal_division_2','분류 선택', false);
                case 2: initSelect('modal_division_parent','분석 항목 선택', false);
                case 3: initSelect('detail_select','세부 항목 선택', false);
            }
        }

		function onChangeDivisionDepth1(){
        	
        	let selectedValue = $('#modal_division_1').val();

			initDivisionSelect(1);
			
			if (selectedValue == -2) {
				newInputOpen(1);
			} else {
				newInputClose(1);
				newInputClose(2);
				newInputClose(3);
				newInputClose(4);
			}

			searchDivision(selectedValue, 2, "modal_division_2");
        }

        function onChangeDivisionDepth2(){
        	
        	let selectedValue = $('#modal_division_2').val();

			initDivisionSelect(2);
			
			if (selectedValue == -2) {
				newInputOpen(2);
			} else {
				newInputClose(2);
				newInputClose(3);
				newInputClose(4);
			}

			searchDivision(selectedValue, 3, "modal_division_parent");
        }

        function onChangeDivisionDepth3(){
        	
        	let selectedValue = $('#modal_division_parent').val();

			initDivisionSelect(3);
			if (selectedValue == -2) {
				newInputOpen(3);
			} else {
				newInputClose(3);
				newInputClose(4);
			}

			searchDivision(selectedValue, 4, "detail_select");
        }
 
        function onChangeDetailSelect(){
        	
            let selectedValue = $('#detail_select').val();
            
            if(selectedValue == -2){
            	
            	newInputOpen(4);
                onKeyupNewItemInput();
            }
            else{
                if(selectedValue != -1 ){
                    $('#_lookup_btn').removeClass("off").addClass('on');
                }
                else{
                    $('#_lookup_btn').removeClass("on").addClass('off');
                }
                
				newInputClose(4);
            }
        }

        function onKeyupNewItemInput(){
            let text = $('#new_item_input_4').val();
            if(text != ''){
                $('#_lookup_btn').removeClass("off").addClass('on');
				$('#_lookup_btn').attr('disabled', false);
            }
            else{
                $('#_lookup_btn').removeClass("on").addClass('off');
				$('#_lookup_btn').attr('disabled', true);
            }
        }

        function searchDivision(division_id, division_depth, select_id){
            
        	if (division_id == -2) {
				let option = `<option value="-2">신규등록</option>`
				$('#' + select_id).append(option);
				return;
			}
        	
        	$.ajax({
                url:'/search-division',
                method:"GET",
                dataType:"JSON",
                data : {
                    "division_id" : division_id,
                    "division_depth" : division_depth,
                    "USEE_AT_CODE" : 3
                },
                success : function(result){
                    if(result.state < 0){
                        getErrorMessage(result.state);
                    }
                    else{
						const list = result.list;
						
						if(division_depth != 4){
							list.forEach(e => {
								let option = `<option value="${e.division_id}">${e.division}</option>`
								$('#' + select_id).append(option);
							})
						}
						
						let option = `<option value="-2">신규등록</option>`
						$('#' + select_id).append(option);
                    }
                }
            })
        }
        
     	// 인풋박스 추가
		function newInputOpen(depth) {

			$("#new_item_div_" + depth).val('');
			$("#new_item_div_" + depth).removeClass("off").addClass("on");
		}

		// 인풋박스 삭제
		function newInputClose(depth) {
			$("#new_item_div_" + depth).val('');
			$("#new_item_div_" + depth).removeClass("on").addClass("off");
		}
		
     	// 파일 등록 확장자 체크
   	 	$('#file_select2').on('change' , function(){
    	
    	 if( $("#file_select2").val() != "" ){
             let ext = $('#file_select2').val().split('.').pop().toLowerCase();
     	  if($.inArray(ext, ['xls','xlsx']) == -1) {
     	     alert('다른 형식의 파일입니다. 엑셀 형식만 업로드 가능 합니다');
     	     $("#file_select2").val(""); // input file 파일명을 다시 지워준다.
     	     return;
    	  	}
         }
   		 })

		function validateFunction(id, title) {
			let value = $('#' + id).val();
			if (value == '') {
				$('#' + id).focus();
				alert(title + ' 입력해주세요');
				return false;
			}
			return true;
		}

		function checkForm() {
			 if(!validateFunction('division_id','분석항목을')){
	                return false;
	         }
	            
	         let selectedValue = $('#work_step').val();
	            
	         if(selectedValue == -1){
	             alert("작업단계를 선택해주세요");
	             $('#work_step').focus();
	             return false;
	         }
	            
	        if(!validateFunction('method_contents','Method 설명을')){
	           	return false;
	        }
			if ($('input[name="template_head"]').val() == '' ||
					$('input[name="template_head"]').val() == '[]') {
				alert("템플릿을 추가해주세요.")
				return false;
			}

			if ($('input[name="template_body"]').val() == '' ||
					$('input[name="template_body"]').val() == '[]') {
				alert("템플릿을 추가해주세요.")
				return false;
			}
			
			return true;
		}

		function onClickRegist() {
			
			const rowLength =  $('.tui-grid-cell-row-header').length-1;
			let template_head = [];
			let template_body = [];
			
			// 컬럼 헤드
			for(let i = 0; i<rowLength; i++){
				
				let body = {};
				
				let row = $('td[data-row-key="'+i+'"]');
				
				for(let j = 1; j<row.length; j++){
					
					let key = row[j].attributes[1].value;
					let value = row[j].textContent;
					
					if(i == 0){
						let head = { header: `${key}`,
                        		  	 name: `${key}`
                    				 }
						template_head.push(head);
					}
					body[key] = value;
					
				}
				template_body.push(body);
			}
			
			$('input[name="template_head"]').val(JSON.stringify(template_head));
            $('input[name="template_body"]').val(JSON.stringify(template_body));
			
			if (!checkForm()) {
				return;
			}
			
			let methodForm = $('#methodForm')[0];
			let formData = new FormData(methodForm);

			$.ajax({
				url : "/method/method_template_add",
				type : "POST",
				processData : false,
				contentType : false,
				data : formData,
				success : function(data) {
					if (data <= 0) {
						getErrorMessage(data);
					} else {
						alert("실험방법이 등록되었습니다");
						location.href = "/method/method_list";
					}
				},
				error : function(xhr, status) {
					alert(xhr + " : " + status);
				}
			})
		}
		
		// 에러 처리
		function getErrorMessage(err_msg_id) {
			$.ajax({
				url : "/err-message",
				type : "GET",
				data : {
					err_msg_id : err_msg_id
				},
				success : function(data) {
					alert(data.msg);
				}
			})
		}

		$('.list_btn').on('click', function() {
			location.href = `/method/method_list`;
		})
	</script>
</body>
</html>