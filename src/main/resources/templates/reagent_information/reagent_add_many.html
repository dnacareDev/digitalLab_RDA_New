<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- 파비콘 -->
<link rel="icon" href="/favicon.ico">
<!-- <link rel="icon" href="../../static/favicon.ico"> -->
<title>Digital Lab - 시약 정보</title>
<link rel="stylesheet" href="/css/common/reset.css">
<link rel="stylesheet" href="/css/common/common.css">
<link rel="stylesheet" href="/css/common/ui.css">
<link rel="stylesheet" href="/css/style/harvesting_after.css">
<link rel="stylesheet" href="/toastGrid/tui-grid.min.css" />
<link rel="stylesheet" href="/toastGrid/tui-pagination.css" />

<script src="/js/common/jquery-3.6.0.js"></script>
<script src="/js/common/loadHeader.js"></script>
<script src="/js/common/common.js"></script>
<script src="/js/harvesting_after.js"></script>


<!-- <link rel="stylesheet" href="../../static/css/common/reset.css">
<link rel="stylesheet" href="../../static/css/common/common.css">
<link rel="stylesheet" href="../../static/css/common/ui.css">
<link rel="stylesheet" href="../../static/css/style/harvesting_after.css">
<link rel="stylesheet" href="../../static/toastGrid/tui-grid.min.css" />
<link rel="stylesheet" href="../../static/toastGrid/tui-pagination.css" />

<script src="../../static/js/common/jquery-3.6.0.js"></script>
<script src="../../static/js/common/loadHeader.js"></script>
<script src="../../static/js/common/common.js"></script>
<script src="../../static/js/harvesting_after.js"></script> -->
<style>
/* table */
.save_table_card .card_cont_box .save_table {
	min-width: 1662px;
	border: 1px solid #d6dce2b7;
	display: block;
}
</style>
</head>
<body>
	<div id="wrap">
		<!-- 공통 구조 - header -->
		<div id="header">
			<th:block th:include="/../header/header.html"></th:block>
		</div>
		<!-- 공통 구조 - header end -->

		<!-- 공통 구조 - main -->
		<main id="main">
			<!-- 공통 구조 - main_header -->
			<th:block th:include="/../header/main_header.html"></th:block>
			<!-- 공통 구조 - main_header end-->

			<!-- 공통 구조 - quick menu -->
            <th:block th:include="/../header/quick_menu.html"></th:block>
            <!-- 공통 구조 - quick menu end -->

			<section class="card_box harvesting_sect">
				<div class="card_title_box">
					<h2 class="card_title">시약 정보</h2>
					<ul class="card_list_text">
						<li class="card_top_list">재료 및 방법 -</li>
						<li class="card_inner_list">시약 정보 -</li>
						<li class="card_inner_list">대량 등록</li>
					</ul>
					<div class="print_box">
						<button class="common_btn1">변경 이력</button>
					</div>
				</div>
				
                


				<!-- <div class="card">
					<div class="card_cont_box">
						<form action="" class="new_enroll_form common_form">
							<div class="form_box file_box">
								<span class="file_title">파일 선택</span>
								<div class="file_input form_inner_box">
									<input type="text" class="file_name" readonly><input
										type="file" name="excelFile" id="file_select1"
										class="file_select_input" data-none="false"
										accept=".xlsx, .xls"><label for="file_select1"
										class="form_btn common_btn1">파일 선택</label>
								</div>
								<span class="ex_text"><span class="star">* </span> 엑셀,
									pdf, hwp 파일만 등록 가능합니다</span>
							</div>
						</form>
					</div>
				</div> -->



				<div class="card save_table_card_">
					<div class="card_cont_box">
						<div id="grid"></div>
						<div class="card_addRe_footer">
		                	<button class="common_btn1 method_btn enroll_btn" style="margin-right: 1040px; width: 150px;">
		                		<a href="/upload/3711475.xlsx" download="시약_대량등록_서식.xlsx">등록서식 다운로드</a>
		                	</button>
							<button type="button" class="add_row_btn common_btn1">추가</button>
							<button type="button" class="delete_btn common_btn1">삭제</button>
						</div>
					</div>
				</div>
				<div class="card_footer">
					<button type="button" class="list_btn common_btn1">목록</button>
					<button type="button" class="save_btn common_btn1">등록</button>
				</div>
			</section>
			<div class="modal harvesting_modal" id="kindSelect">
				<div class="modal_box">
					<div class="modal_header">
						<h2 class="modal_title">분석 항목 조회</h2>
						<button class="modal_close">닫기</button>
					</div>
					<form action="" class="modal_form common_form lookup_form">
						<div class="select_box modal_input_box">
							<p for="" class="modal_form_title">품종/유전정보</p>
							<div class="raido_box_wrap">
								<div class="radio_box">
									<input type="radio" name="kindInfo" id="_kind"> <label
										for="_kind"></label>
								</div>
								<div class="radio_box">
									<input type="radio" name="kindInfo" id="_genetic"> <label
										for="_genetic"></label>
								</div>
								<div class="radio_box">
									<input type="radio" name="kindInfo" id="_etc"> <label
										for="_etc"></label>
								</div>
							</div>
						</div>
						<div class="select_box modal_input_box">
							<label for="" class="modal_form_title">용도</label> <select
								class="common_select" id="">
								<option value="" hidden>용도 선택</option>
								<option value="">기능성</option>
								<option value="">2</option>
								<option value="">3</option>
							</select>
						</div>
						<div class="select_box modal_input_box">
							<label for="" class="modal_form_title">분류</label> <select
								class="common_select" id="">
								<option value="" hidden>용도 선택</option>
								<option value="">기능성 관련 성분</option>
								<option value="">2</option>
								<option value="">3</option>
							</select>
						</div>
						<div class="form_box modal_input_box off">
							<label for="" class="modal_form_title">신규 세부 항목</label> <input
								type="text" id="" class="">
						</div>
					</form>
					<div class="modal_footer">
						<button class="common_btn1 modal_btn off">사용</button>
					</div>
				</div>
			</div>
		</main>
		<!-- 공통 구조 - main end -->
	</div>

	<script src="/toastGrid//tui-pagination.js"></script>
	<script src="/toastGrid//tui-grid.min.js"></script>
	
	<script type="text/javascript" th:inline="javascript">
		
		let placeList = [[${placeList}]];
		let eachList = [[${eachList}]];
	
		let columndata = [{
			header : '*품명',
			name : 'reagent_name',
			editor : 'text',
			width : 'auto',
			minWidth : 180,
			align : 'center'
		}, {
			header : '규격',
			name : 'reagent_standard',
			editor : 'text',
			width : 80,
			align : 'center'
		}, {
			header : 'CAS No.',
			name : 'reagent_cas',
			editor : 'text',
			width : 120,
			align : 'center'
		}, {
			header : '순도/농도',
			name : 'reagent_density',
			editor : 'text',
			width : 120,
			align : 'center'
		}, {
			header : '화학식',
			name : 'reagent_formula',
			editor : 'text',
			width : 120,
			align : 'center'
		}, {
			header : '영문별칭',
			name : 'reagent_nick_e',
			editor : 'text',
			width : 120,
			align : 'center'
		}, {
			header : '국문별칭',
			name : 'reagent_nick_k',
			editor : 'text',
			width : 120,
			align : 'center'
		}, {
			header : '제조사',
			name : 'reagent_production',
			editor : 'text',
			width : 120,
			align : 'center'
		}, {
			header : '수량',
			name : 'reagent_amount',
			editor : 'text',
			width : 120,
			align : 'center'
		}]
		
		const each = {
				header : '단위 ▼',
				name : 'each_id',
				editor: {
				      type: 'select',
				      options: {
				        listItems: [
				          
				        ]
				      }
				    }, 
				width : 120,
				align : 'center'
			} 
		
		eachList.forEach((item)=>{
			each.editor.options.listItems.push({ text: item.each , value: item.each })
		})
		
		columndata.push(each)
		columndata.push({
			header : 'Comment',
			name : 'reagent_comment',
			editor : 'text',
			width : 120,
			align : 'center'
		})
		
		/*
		columndata.push({
			header : '보관장소',
			name : 'place_id',
			editor : 'text',
			width : 120,
			align : 'center'
		})
		*/
		
		const place = {
						header : '보관장소',
						name : 'place_id',
						editor: {
						      type: 'select',
						      options: {
						        listItems: [
						          
						        ]
						      }
						    },     
						width : 150,
						align : 'center'
						} 
		placeList.forEach((item)=>{
			place.editor.options.listItems.push({ text: item.place_name , value: item.place_name })
		})

		columndata.push(place)
		/*
		columndata.push({
			header : '사용여부',
			name : 'reagent_use',
			editor : 'text',
			width : 120
		})
		*/
		
	</script>
	<script>
		// toast- grid
		let rowdata = [];
		
		let checkRow = [];
		let rowLength;
		
		// row key
		let rowKey = 4;
		
		for(let i = 0; i<=rowKey; i++){
			rowdata.push({});
		}
		
		const Grid = tui.Grid;

		let instance = new Grid({
			el : document.getElementById('grid'), // Container element
			minBodyHeight : 5,
			scrollX : true,
			scrollY : false,
			rowHeaders : [ 'rowNum' ],
			columnOptions: {
                resizable: true
              },
			pageOptions : {
				perPage : 5
			},
			data : rowdata,
			columns : columndata,
			contextMenu: ({ rowKey, columnName }) => (
				[
					[
						{
							name: 'edit',
							label: 'Edit',
							action: () => {instance.startEditing(rowKey, columnName)}
						}
					]	
				])
			});
			//instance.resetData(newData); // Call API of instance's public method
			Grid.applyTheme('clean'); // Call API of static method
		
		instance.on('check' , (ev) =>{
			checkRow.push(`${ev.rowKey}`);
		})
		
		instance.on('uncheck' , (ev) =>{
			const check = checkRow.indexOf(`${ev.rowKey}`);
			checkRow.splice(check , 1);
		})
		
		
		// 규격에 맞는 값이 아닐경우 글자 빨간색
		instance.on('afterChange', (ev) => {
			//console.log("ev : ", ev);
			
			for(let i=0 ; i<ev.changes.length ; i++) {
				const row_key = ev.changes[i].rowKey;
				const column_name = ev.changes[i].columnName;
				const value = ev.changes[i].value
				
				//css를 적용할 위치 선정 | cell_coordinate.css('color', '#FF0000');
				const cell_coordinate = $('[data-row-key="' + row_key + '"][data-column-name="' + column_name + '"]');
				
				switch(column_name) {
					case 'each_id':
						for(let i=0 ; i<eachList.length ; i++) {
							if(eachList[i].each === value) {
								cell_coordinate.css('color', 'black');
								break;
							}
							
							if(i == eachList.length - 1) {
								//console.log("not here");
								cell_coordinate.css('color', '#FF0000');
							}
						}
						break;
						
					case 'reagent_amount':
						if(isNaN(value)) {
							cell_coordinate.css('color', '#FF0000');
						} else {
							cell_coordinate.css('color', 'black');
						}
						break;
						
					case 'place_id':
						for(let i=0 ; i<placeList.length ; i++) {
							if(placeList[i].place_name === value) {
								//console.log("black");
								cell_coordinate.css('color', 'black');
								break;
							}
							
							if(i == placeList.length - 1) {
								//console.log("red");
								cell_coordinate.css('color', '#FF0000');
							}
						}
						break;
				}
			}
		});
		
		
		
		
		// 로우 추가
		$('.add_row_btn').on('click' , function(){
			instance.appendRow([{}], {
				  extendPrevRowSpan: true,
				  focus: true
				});
			
			rowKey++;
		})
		
		// 로우 삭제
		$('.delete_btn').on('click' ,function(){
			
			instance.removeRow(rowKey);
			rowKey--;
			
		})
		
		$('.list_btn').on('click', function() {
			location.href = `/reagent/reagent_list`;
		})
		
		// 등록 
		$('.save_btn').on('click' , function(){
			
			const reagentList = [];
			
			const rowLength =  $('.tui-grid-cell-row-header').length - 1;
			
			// 컬럼 헤드
			for(let i = 0; i<rowLength; i++){
				
				let row = instance.getRow(i);
				
				// 품명 체크
				if(row.reagent_name == null){
					alert(`${i+1}번 품명을 입력해주세요`)
					return;
				}
					
				// 수량 체크
				if(row.reagent_amount != null){
					if(isNaN(row.reagent_amount)){
						alert(`${i+1}번 수량의 숫자를 입력해주세요`);
						return;
					}								
				}
					
				// 단위 체크
				if(row.each_id != null){
						
					let check = true;
					eachList.forEach((item) => {
						
						if(row.each_id == item.each){
							row.each_id = item.each_id
							check = false							
							return false;
						}
					})
					
					if(check){
						alert(`${i+1}번 단위를 확인해주세요`);
						return;
					}
				}
				
				// 장소 체크
				if(row.place_id != null){
						
					let check = true;
					placeList.forEach((item) => {
						
						if(row.place_id == item.place_name){
							row.place_id = item.place_id
							check = false							
							return false;
						}
					})
					
					if(check){
						alert(`${i+1}번 보관장소를 확인해주세요`);
						return;
					}
				}
				
				reagentList.push(row);
			}
			
			$.ajax({
				type : "POST",
				url : "/reagent/reagent_many_add",
				data : JSON.stringify({"reagentList" : reagentList}),
				contentType: 'application/json; charset=utf-8',
				success : function(data) {
		        		
						if(data.result.length > 0){
							
							// 에러리스트
							let errorMessage = '';
							data.result.forEach((item)=>{
								if(item.errCode == -1){
									errorMessage += `${item.index}번 ${item.reagent.reagent_name} 등록이 실패했습니다.\n`
								}
								if(item.errCode == -2){
									errorMessage += `${item.index}번 ${item.reagent.reagent_name} 품명이 중복됬습니다.\n`
								}
							})
							alert(errorMessage);
						}else{
			                alert("시약이 등록되었습니다");
				            location.href="/reagent/reagent_list";
						}
				},
				error : function(xhr,status) {
					alert(xhr + " : " + status);
				}
			});
		})
		
	</script>
</body>
</html>