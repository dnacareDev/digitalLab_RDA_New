<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 파비콘 -->
    <link rel="icon" href="/favicon.ico">
    <!-- <link rel="icon" href="../../static/favicon.ico"> -->
    <title>Digital Lab - 분석 계획 설정</title>
    <link rel="stylesheet" href="/css/common/reset.css">
    <link rel="stylesheet" href="/css/common/common.css">
    <link rel="stylesheet" href="/css/common/ui.css">
    <link rel="stylesheet" href="/css/style/harvesting_after.css">

    <script src="/js/common/jquery-3.6.0.js"></script>
    <script src="/js/common/loadHeader.js"></script>
    <script src="/js/common/common.js"></script>
    <script src="/js/harvesting_after.js"></script>


    <!-- <link rel="stylesheet" href="../../static/css/common/reset.css">
    <link rel="stylesheet" href="../../static/css/common/common.css">
    <link rel="stylesheet" href="../../static/css/common/ui.css">
    <link rel="stylesheet" href="../../static/css/style/harvesting_after.css">

    <script src="../../static/js/common/jquery-3.6.0.js"></script>
    <script src="../../static/js/common/loadHeader.js"></script>
    <script src="../../static/js/common/common.js"></script>
    <script src="../../static/js/harvesting_after.js"></script> -->
    <style>
        #main .explane_box {width: 100%; padding-left: 0; margin-bottom: 30px;}

        .regi_file {padding-top: 10px; padding-left: 5px;}
        .regi_file > a,
        .regi_file > span {font-size: 1.4rem;}
        .regi_file > span {margin-right: 5px;}
        .regi_file > a {color: #6875E9; font-weight: 700;}
        .regi_file > a:hover {text-decoration: underline;}

        #main .harvesting_sect .card {padding-bottom: 30px;}

        .harvesting_add_box .card_header {display: flex; align-items: center;}
        .harvesting_add_box .card_header > h2 {margin-right: 10px;}
        .harvesting_add_box .card_header > .common_btn1 {height: 30px; line-height: 30px; width: 70px; font-size: 1.4rem;}
    </style>
</head>
<body>
    <div id="wrap">
       <!-- 공통 구조 - header -->
        <div id="header">
			<th:block th:include="/../header/header.html"></th:block>
		</div>
        <!-- 공통 구조 - header end -->
        
        <!-- 공통 구조 - main -->
        <main id="main">
			<!-- 공통 구조 - main_header -->
            <th:block th:include="/../header/main_header.html"></th:block>
            <!-- 공통 구조 - main_header end-->

            <!-- 공통 구조 - quick menu -->
            <th:block th:include="/../header/quick_menu.html"></th:block>
            <!-- 공통 구조 - quick menu end -->
            
            <section class="card_box harvesting_sect">
                <div class="card_title_box">
                    <h2 class="card_title">분석 계획 설정</h2>
                    <ul class="card_list_text">
                        <li class="card_top_list">분석 관리 - </li>
                        <li class="card_inner_list">분석 계획 설정 - </li>
                        <li class="card_inner_list">일반 수정</li>
                        <li th:text="' - '+${result.plan.plan_code}"></li>
                    </ul>
                    <div class="print_box">
                        <button class="form_btn common_btn1 modal_on_btn" data-modal="logModal" style="display: block">변경 이력</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card_cont_box harvesting_add_box"> 
                       <form action="" class="harvesting_form common_form">
                            <div class="form_box task_box select_box">
                                <label for="" class="file_title">과제 정보</label>
                                <select name="" id="" class="task_select common_select" disabled="disabled">
                                    <th:block th:each="item : ${reportList.list}">
										<option th:value="${item.report_id}" th:selected="${item.report_id} == ${result.plan.report_id}"><span th:text="${item.tot_rsch_start_year}+' - ('+${item.prj_dtl_no}+') '+${item.prj_dtl_nm}"></span></option>
									</th:block>
                                </select>
                            </div>
                            <div class="form_box task_box select_box">
                                <label for="" class="file_title">분석 종류</label>
                                <input type="text" name="" id="" th:value="${result.plan.division_depth_4}" disabled>
                            </div>
                            <div class="form_box task_box select_box">
                                <label for="" class="file_title">품종/유전자원정보</label>
                                <input type="text" name="" id="genetic" value="옥수수(단옥3호), 옥수수(고당옥), 옥수수(수원단85호)" disabled>
                            </div>
                            <div class="form_box explane_box">
                               <div class="regi_file">
                                   <span>등록 파일 : </span><a download th:href="'/download/file?path=' + ${result.plan.ATCH_FILE_NM}">[[${result.plan.ORIG_FILE_NM}]]</a>
                               </div>
                            </div>
                            <div class="card_header">
                                <h2 class="header_title">Step1. 일정 및 담당자 지정</h2> <button class="common_btn1 modal_on_btn" data-modal="scheduleContSet" onclick="onClickSetSchedule()">설정</button>
                            </div>
                            <table class="card3_cont_table">
                                <thead class="step_2_table">
                                    <tr>
                                        <th>담당자(정)</th>
                                        <th>담당자(부)</th>
                                        <th>시작일</th>
                                        <th>종료일</th>
                                    </tr>
                                </thead>
                                <tbody id="mgr_tbody">
<!--                                    <tr>-->
<!--                                        <td><span></span></td>-->
<!--                                        <td><span></span></td>-->
<!--                                        <td><span></span></td>-->
<!--                                        <td><span></span></td>-->
<!--                                    </tr>-->
                                </tbody>
                           </table>
                       </form>

                    </div>
                </div>
                <div class="card step_3_card on">
                    <div class="card_header">
                        <h2 class="header_title">Step 2 . Comment</h2>
                    </div>
                    <div class="card_cont_box">
                        <form action="" class="common_form">
                            <div class="form_box">
                                <label for="" class="file_title"></label>
                                <textarea name="" id="comment" th:text="${result.plan.plan_contents}" class="" placeholder="Comment"></textarea>
                            </div> 
                        </form>
                    </div>        
                </div>
                <div class="card_footer">
                    <button class="list_btn common_btn1" onclick="location.href='/analysis_plan_list'">목록</button>
                    <button th:if="${session.LOGIN_MEMBER.account == result.plan.account}" class="save_btn common_btn1" onclick="onClickSave()">저장</button>
                </div>
            </section>
            <div class="modal harvesting_modal" id="kindSelect">
                <div class="modal_box">
                    <div class="modal_header">
                        <h2 class="modal_title">분석 항목 조회</h2>
                        <button class="modal_close">닫기</button>
                    </div>
                    <form action="" class="modal_form common_form lookup_form">
                        <div class="select_box modal_input_box">
                            <p for="" class="modal_form_title">품종/유전정보</p>
                            <div class="raido_box_wrap">
                                <div class="radio_box">
                                    <input type="radio" name="kindInfo" id="_kind"> 
                                    <label for="_kind"></label>
                                </div>
                                <div class="radio_box">
                                    <input type="radio" name="kindInfo" id="_genetic">
                                    <label for="_genetic"></label>
                                </div>
                                <div class="radio_box">
                                    <input type="radio" name="kindInfo" id="_etc"> 
                                    <label for="_etc"></label>
                                </div>
                            </div>
                        </div>
                        <div class="select_box modal_input_box">
                            <label for="" class="modal_form_title">용도</label>
                            <select class="common_select" id="">
                                <option value="" hidden>용도 선택</option>
                                <option value="">기능성</option>
                                <option value="">2</option>
                                <option value="">3</option>
                            </select>
                        </div>
                        <div class="select_box modal_input_box">
                            <label for="" class="modal_form_title">분류</label>
                            <select class="common_select" id="">
                                <option value="" hidden>용도 선택</option>
                                <option value="">기능성 관련 성분</option>
                                <option value="">2</option>
                                <option value="">3</option>
                            </select>
                        </div>
                        <div class="form_box modal_input_box off">
                            <label for="" class="modal_form_title">신규 세부 항목</label>
                            <input type="text" id="" class="">
                        </div> 
                    </form>
                    <div class="modal_footer">
                        <button class="common_btn1 modal_btn off">사용</button>
                    </div>
                </div>
            </div>

            <div class="modal harvesting_modal scheduleCont_modal" id="scheduleContSet">
                <div class="modal_box">
                    <div class="modal_header">
                        <h2 class="modal_title">일정 및 담당자 설정</h2>
                        <button class="modal_close">닫기</button>
                    </div>
                    <div class="top_cont_box">
                        <div class="cont_left_box cont_list_box" id="plan_manager_list">
                            <span class="file_title">담당자 (정)</span>
                            <table class="main_manager_table manager_table card3_cont_table">
                                <thead>
                                <tr>
                                    <th><span></span></th>
                                    <th><span>이름</span></th>
                                    <th><span>연구실</span></th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr data-user_id="21">
                                    <td>
                                        <div>
                                            <label for="" class="check_wrap">
                                                <input type="radio" name="kindInfo" id=""  class="checkbox">
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span>홍길동</span>
                                    </td>
                                    <td>
                                        <span>유용소재연구실</span>
                                    </td>
                                </tr>
                                <tr data-user_id="11">
                                    <td>
                                        <div>
                                            <label for="" class="check_wrap">
                                                <input type="radio" name="kindInfo" id=""  class="checkbox">
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span>홍길동</span>
                                    </td>
                                    <td>
                                        <span>유용소재연구실</span>
                                    </td>
                                </tr>
                                <tr data-user_id="6">
                                    <td>
                                        <div>
                                            <label for="" class="check_wrap">
                                                <input type="radio" name="kindInfo" id=""  class="checkbox">
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span>홍길동</span>
                                    </td>
                                    <td>
                                        <span>유용소재연구실</span>
                                    </td>
                                </tr>
                                <tr data-user_id="3">
                                    <td>
                                        <div>
                                            <label for="" class="check_wrap">
                                                <input type="radio" name="kindInfo" id=""  class="checkbox">
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span>홍길동</span>
                                    </td>
                                    <td>
                                        <span>유용소재연구실</span>
                                    </td>
                                </tr>
                                <tr data-user_id="1">
                                    <td>
                                        <div>
                                            <label for="" class="check_wrap">
                                                <input type="radio" name="kindInfo" id=""  class="checkbox">
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span>홍길동</span>
                                    </td>
                                    <td>
                                        <span>유용소재연구실</span>
                                    </td>
                                </tr>
                                <tr data-user_id="12">
                                    <td>
                                        <div>
                                            <label for="" class="check_wrap">
                                                <input type="radio" name="kindInfo" id=""  class="checkbox">
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span>홍길동</span>
                                    </td>
                                    <td>
                                        <span>유용소재연구실</span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <p class="manager_name_list"></p>
                        </div>
                        <div class="cont_right_box cont_list_box" id="manager_list">
                            <span class="file_title">담당자 (부)</span>
                            <table class="sub_manager_table manager_table card3_cont_table">
                                <thead>
                                <tr>
                                    <th><span></span></th>
                                    <th><span>이름</span></th>
                                    <th><span>연구실</span></th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr data-user_id="22">
                                    <td>
                                        <div>
                                            <label for="" class="check_wrap">
                                                <input type="checkbox" name="" id="" class="checkbox">
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span>홍길동</span>
                                    </td>
                                    <td>
                                        <span>품질관리연구실</span>
                                    </td>
                                </tr>
                                <tr data-user_id="3">
                                    <td>
                                        <div>
                                            <label for="" class="check_wrap">
                                                <input type="checkbox" name="" id="" class="checkbox">
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span>홍길동</span>
                                    </td>
                                    <td>
                                        <span>품질관리연구실</span>
                                    </td>
                                </tr>
                                <tr data-user_id="4">
                                    <td>
                                        <div>
                                            <label for="" class="check_wrap">
                                                <input type="checkbox" name="" id="" class="checkbox">
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span>홍길동</span>
                                    </td>
                                    <td>
                                        <span>품질관리연구실</span>
                                    </td>
                                </tr>
                                <tr data-user_id="5">
                                    <td>
                                        <div>
                                            <label for="" class="check_wrap">
                                                <input type="checkbox" name="" id="" class="checkbox">
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span>홍길동</span>
                                    </td>
                                    <td>
                                        <span>품질관리연구실</span>
                                    </td>
                                </tr>
                                <tr data-user_id="12">
                                    <td>
                                        <div>
                                            <label for="" class="check_wrap">
                                                <input type="checkbox" name="" id="" class="checkbox">
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span>홍길동</span>
                                    </td>
                                    <td>
                                        <span>품질관리연구실</span>
                                    </td>
                                </tr>
                                <tr data-user_id="3">
                                    <td>
                                        <div>
                                            <label for="" class="check_wrap">
                                                <input type="checkbox" name="" id="" class="checkbox">
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span>홍길동</span>
                                    </td>
                                    <td>
                                        <span>품질관리연구실</span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <p class="manager_name_list"></p>
                        </div>
                    </div>
                    <form action="" class="scheduleCont_form common_form">
                        <div class="form_box">
                            <label for="" class="file_title">일정 등록</label>
                            <div class="schedule_date_box">
                                <input type="date" id="start_date" name="start_date" placeholder="시작일">
                                <input type="date" id="end_date" name="end_date" placeholder="종료일">
                            </div>
                        </div>
                        <div class="form_box">
                            <label for="" class="file_title">Comment</label>
                            <textarea name="" id="" class="manage_comments"></textarea>
                        </div>
                    </form>
                    <div class="modal_footer">
                        <button class="common_btn1 modal_btn" onclick="onClickSaveSChedule()" id="schedule_save">저장</button>
                    </div>
                </div>
            </div>

            <div class="modal harvesting_modal" id="logModal">
                <div class="modal_box">
                    <div class="modal_header">
                        <h2 class="modal_title">변경 이력 조회</h2>
                        <button class="modal_close">닫기</button>
                    </div>
                    <div class="card sec_card">
                        <div class="card_cont_box">
                            <ul class="change_list_box">

                                <th:block th:each=" log : ${result.logList}">
                                    <li class="change_list">
                                        <span class="change_check"></span>
                                        <div class="chang_text_box">
                                            <p class="change_text"><span th:text="${log.data_code}"></span>
                                                <th:block th:switch="${log.action_type}">
                                                    <span th:case="1">등록</span>
                                                    <span th:case="2">수정</span>
                                                    <span th:case="3">삭제</span>
                                                    <span th:case="4">분석 설정</span>
                                                    <span th:case="5">시료 분석</span>
                                                    <span th:case="6">결과 등록</span>
                                                </th:block>
                                            </p>
                                            <span class="change_date" th:text="${log.log_date}"></span>
                                        </div>
                                    </li>
                                </th:block>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
           <!-- 공통 구조 - main end -->
    </div>
        <script th:inline="javascript" type="text/javascript">
            console.log([[${result}]])
            $(document).ready(function(){
                const genetic_1 = [[${result.plan.genetic_depth_1}]];
                const genetic_2 = [[${result.plan.genetic_depth_2}]]
                const text = `${genetic_1}(${genetic_1})`
                $('#genetic').val(text)
                getStepDataByMethodId();

                const schedule = [[${result.schedule}]];
                schedule.forEach(e => {
                    let main = "";
                    let mainName = "";
                    let sub = [];
                    let subName = [];

                    const comment = e.sch_contents;
                    const start_date = e.start_date;
                    const end_date = e.end_date;

                    for(let i = 0; i < e.managerList.length; i++){
                        let manager = e.managerList[i];
                        if(manager.mgr_type == 1){
                            main += manager.account;
                            mainName += manager.user_name;
                        }
                        else if(manager.mgr_type == 2){
                            sub.push(manager.account);
                            subName.push(manager.user_name);
                        }
                    }

                    const tr =
                        `
                     <tr data-main_manager_id="${main}" data-sub_manager_ids="${sub.join(',')}" data-comment="${comment}">
                    <td>${mainName}</td>
                    <td>${subName.join(',')}</td>
                    <td>${start_date}</td>
                    <td>${end_date}</td>
                        </tr>
                    `
                    $('#mgr_tbody').append(tr);
                });

            })

            function getStepDataByMethodId(){
                $.ajax({
                    url : `/api/user/search_user`,
                    method : "GET",
                    dataType : "JSON",
                    success : function(result) {
                        saveScheduleInfo()
                        if (Array.isArray(result?.result)){
                            setStepManagers(result?.result)
                        }
                    },
                    error: (err) => {
                        console.error(err)
                        saveScheduleInfo()
                    }
                })
            }

            function saveScheduleInfo(){
                const saveBtn = document.querySelector('#schedule_save');
               	saveBtn.addEventListener('click', (e) => {
                    const trs = document.querySelectorAll('.main_manager_table tbody tr');

                    trs.forEach((tr, index) => {
                        const data = tr.querySelectorAll('td');
                        const supervisor = tr.querySelectorAll('td')[2].innerText
                        //const managers = tr.querySelectorAll('td')[3].innerText.split(",");
                        const managerList = []
                        const subMainIds = tr.dataset.sub_manager_ids?.split(",") ?? []

                        const obj = {
                            user_name: "",
                            user_id: 0,
                            mgr_type: 2 //정 1, 부 2
                        }
                        if (tr.dataset.main_manager_id) {
                            managerList.push({
                                ...obj ,
                                user_name: supervisor,
                                mgr_type: 1,
                                user_id: tr.dataset.main_manager_id
                            })
                        }

                        if (subMainIds.length > 0) {
                            subMainIds.forEach((manager, index) => {
                                managerList.push({
                                    ...obj ,
                                    user_name: managers[index],
                                    user_id: manager
                                })
                            })
                        }

                        const rowObj = {
                            index,
                            step_name: data[1].innerText,
                            step_supervisor: data[2].innerText,
                            step_managers: data[3].innerText,
                            batch_index: batchIndex,
                            step_id : tr.dataset.step_id,
                            step_info: data[1].innerText,
                            step_start_date: data[4].innerText,
                            step_end_date: data[5].innerText,
                            managerList,
                            comment: tr.dataset.comment,
                            sub_manager_ids: tr.dataset.sub_manager_ids,
                            main_manager_id: tr.dataset.main_manager_id,

                        }
                        stepDataByBatch[batchIndex][index] = rowObj;
                    })
                    resetStepModal()
                    stepModal.classList.remove('on')
                    document.querySelectorAll('.enroll_btn').forEach(btn => {
                        btn.classList.remove('active');
                    })

                    renderStepSettings()
                    document.querySelector('#main').classList.remove('modal_on');
                })
            }

            function setStepManagers(list) {
                let html = "";
                let html2 = "";
                list.forEach((manager) => {
                	
                	let groupArr = manager.groupName.split('/');
        			let groupName = groupArr[groupArr.length-1]
                	
                    const tr = `
            <tr data-user_id="${manager?.account}">
                <td>
                    <div>
                        <label for="" class="check_wrap">
                            <input type="radio" name="kindInfo" id="" class="checkbox">
                        </label>
                    </div>
                </td>
                <td>
                    <span>${manager?.name}</span>
                </td>
                <td>
                    <span>${groupName}</span>
                </td>
            </tr>
            `;
                    html += tr;
                    const tr2 = `
            <tr data-user_id="${manager?.account}">
                <td>
                    <div>
                        <label for="" class="check_wrap">
                            <input type="checkbox" id="" class="checkbox">
                        </label>
                    </div>
                </td>
                <td>
                    <span>${manager?.name}</span>
                </td>
                <td>
                    <span>${groupName}</span>
                </td>
            </tr>
            `;
                    html2 += tr2;
                })
                const mainManagerTable = document.querySelector('.main_manager_table tbody');
                const subManagerTable = document.querySelector('.sub_manager_table tbody');
                mainManagerTable.innerHTML = html;
                subManagerTable.innerHTML = html2;
            }


            function onClickSaveSChedule(){
                
                const mainManagerTable = document.querySelectorAll('.main_manager_table tbody tr')
                const subManagerTable = document.querySelectorAll('.sub_manager_table tbody tr')

                let mainMangerId = "";
                let mainMangerName = "";
                
                let mainCheck = true;
                let subCheck = true;
                
                mainManagerTable.forEach(tr => {
                    const checked = tr.querySelector('.checkbox')?.checked;
                    if (checked) {
                        mainMangerId += (tr.dataset.user_id)
                        mainMangerName += tr.querySelectorAll('td')[1].innerText
                        
                        mainCheck = false;
                    }
                })
                

                let subMangerIds = [];
                let subMangerNames = [];
                subManagerTable.forEach((tr, index) => {
                    const checked = tr.querySelector('.checkbox')?.checked;
                    if (checked) {
                        subMangerIds.push(tr.dataset.user_id);
                        subMangerNames.push(tr.querySelectorAll('td')[1].innerText)
                        
                        subCheck = false;
                    }
                })
                
                if(mainCheck){
                	alert("담당자(정)을 선택해주세요")
                	return;
                }
                
                if(subCheck){
                	alert("담당자(부)을 선택해주세요")
                	return;
                }
                
                if (!checkDate()) return;

                //subMangerIds = subMangerIds.slice(0, -1);

                const batchSettings = document.querySelectorAll('#mgr_tbody tr')[0];

                const scheduleModal =  document.querySelector('#scheduleContSet');
                const date =  [...scheduleModal.querySelectorAll('input[type="date"]')].map(el => el.value);
                console.log(date);
                const comment = document.querySelector('.manage_comments').value;
                console.log(batchSettings)
                if(!batchSettings){
                    let tr =
                        `
                            <tr data-main_manager_id="${mainMangerId}" data-sub_manager_ids="${subMangerIds}" data-comment="${comment}">
                                <td>${mainMangerName}</td>
                                <td>${subMangerNames}</td>
                                <td>${date[0]}</td>
                                <td>${date[1]}</td>
                            </tr>
                        `
                    console.log("test",tr);
                    $('#mgr_tbody').append(tr);
                }
                else {

                    console.log(mainMangerId);
                    batchSettings.dataset.main_manager_id = mainMangerId
                    batchSettings.dataset.sub_manager_ids = subMangerIds
                    batchSettings.dataset.comment = comment;


                    const supervisor = document.querySelector('#plan_manager_list .manager_name_list').innerText;
                    const managerList = document.querySelector('#manager_list .manager_name_list').innerText;

                    batchSettings.querySelectorAll('td')[0].innerText = mainMangerName;
                    batchSettings.querySelectorAll('td')[1].innerText = subMangerNames;
                    batchSettings.querySelectorAll('td')[2].innerText = date[0];
                    batchSettings.querySelectorAll('td')[3].innerText = date[1];
                }

                $('#scheduleContSet').removeClass('on');
                $('#main').removeClass('modal_on');
            }

            function splitManageText(str){
                const data = str.split(",");
                var names = data.length > 1 ? data.map((v, i) => v.split("(")[0]).join(",") : data.join("")
                return names;
            }

            function onClickSave(){
                const manager_id = $('#mgr_tbody tr').data('main_manager_id');
                const sub_manager_id = $('#mgr_tbody tr').data('sub_manager_ids');
                const sch_comment = $('#mgr_tbody tr').data('comment');
                const start_date = document.querySelectorAll('#mgr_tbody tr td')[2].innerText;
                const end_date = document.querySelectorAll('#mgr_tbody tr td')[3].innerText;
                const comment = $('#comment').val();
                const plan_id = [[${result.plan.plan_id}]]
                let plan_code = [[${result.plan.plan_code}]]

                $.ajax({
                    url:'/analysis/plan-set-easy',
                    method:'POST',
                    data:{
                        'manager_id' : manager_id,
                        'sub_manager_id' : sub_manager_id,
                        'sch_comment' : sch_comment,
                        'start_date' : start_date,
                        'end_date' : end_date,
                        'comment' : comment,
                        'plan_id' : plan_id,
                        'plan_code' : plan_code
                    },
                    success : function(result){
                        alert("수정에 성공하셨습니다.");
                        location.reload();
                    }
                })

            }

            function checkDate(){
                const startDate = document.querySelector('input[name="start_date"').value;
                const endDate = document.querySelector('input[name="end_date"').value;

                if (isEmpty(startDate)) {
                    alert('시작일을 선택해주세요');
                    return false
                }
                
                if (isEmpty(endDate)) {
                    alert('종료일을 선택해주세요');
                    return false;
                }
                
                return true;
            }

            function onClickSetSchedule(){
                const batchSettings = document.querySelectorAll('#mgr_tbody tr')[0];
                console.log(batchSettings);
                const mgr_id = batchSettings.dataset.main_manager_id;
                const sub_id = batchSettings.dataset.sub_manager_ids;
                const comment = batchSettings.dataset.comment;

                const managerList = document.querySelectorAll('.main_manager_table tbody tr')
                managerList.forEach(manager => {
                    if(manager.dataset.user_id == mgr_id){
                        console.log("manager")
                        manager.querySelector('input[type="radio"]').click();
                    }
                })

                const subList = document.querySelectorAll('.sub_manager_table tr');
                const subArr = sub_id.split(',');
                console.log(subArr);
                subList.forEach(sub =>{
                    for(let i = 0; i < subArr.length; i++){
                        if(subArr[i] == sub.dataset.user_id){
                            sub.querySelector('input[type="checkbox"]').click();
                        }
                    }
                })
                console.log(comment);
                $('.manage_comments').text(comment);

                const start_date= batchSettings.querySelectorAll('td')[2].innerText;
                const end_date= batchSettings.querySelectorAll('td')[3].innerText;
                document.querySelector('.schedule_date_box input[name="start_date"]').value = start_date;
                document.querySelector('.schedule_date_box input[name="end_date"]').value = end_date;
            }

            function onClickDownload(src){
                $.ajax({
                    url:'/download/file',
                    method:'GET',
                    data:{
                        'path' : src
                    },
                    success : function(){

                    }

                })
            }
            
         // 날짜 선택
    		$('input[type="date"]').on('change', function(e) {
    			
    			let start = $('#start_date').val();
    			let end = $('#end_date').val();
    			let startDate = new Date(start);
    			let endDate = new Date(end);
    			
    			if (isEmpty(end)) {
    				document.getElementById('end_date').valueAsDate = startDate;
    			}else if(isEmpty(start)){
    				document.getElementById('start_date').valueAsDate = endDate;
    			}else if(e.target.id == 'end_date' && (endDate - startDate) < 0){
    				document.getElementById('start_date').valueAsDate = endDate;	
    			}else if(e.target.id == 'start_date' && (endDate - startDate) < 0){
    				document.getElementById('end_date').valueAsDate = startDate;	
    			}
    			
    		});
    		
    		// 빈값 확인
    		let isEmpty = (val) => {
    			if(val === '' || val === null || val === undefined || (val !== null && typeof val === 'object' && !Object.keys(val).legth)){
    				return true;
    			}else{
    				return false;
    			}
    		}

        </script>
</body>
</html>