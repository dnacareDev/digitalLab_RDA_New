<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/html">
<head>
<th:block th:include="./fragments/header.html"></th:block>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 파비콘 -->
    <link rel="icon" href="/favicon.ico">
    <!-- <link rel="icon" href="../../static/favicon.ico"> -->
    <title>Digital Lab - 분석 계획 설정</title>
    <link rel="stylesheet" href="/css/common/reset.css">
    <link rel="stylesheet" href="/css/common/common.css">
    <link rel="stylesheet" href="/css/common/ui.css">
    <link rel="stylesheet" href="/css/style/harvesting_after.css">
    
    <script src="/js/common/jquery-3.6.0.js"></script>
    <script src="/js/common/loadHeader.js"></script>
    <script src="/js/common/common.js"></script>


    <!-- <link rel="stylesheet" href="../../static/css/common/reset.css">
    <link rel="stylesheet" href="../../static/css/common/common.css">
    <link rel="stylesheet" href="../../static/css/common/ui.css">
    <link rel="stylesheet" href="../../static/css/style/harvesting_after.css">
    
    <script src="../../static/js/common/jquery-3.6.0.js"></script>
    <script src="../../static/js/common/loadHeader.js"></script>
    <script src="../../static/js/common/common.js"></script> -->
</head>
<body>
    <div id="wrap">
        <!-- 공통 구조 - header -->
        <div id="header">
			<th:block th:include="/../header/header.html"></th:block>
		</div>
        <!-- 공통 구조 - header end -->
        
        <!-- 공통 구조 - main -->
        <main id="main">
			<!-- 공통 구조 - main_header -->
            <th:block th:include="/../header/main_header.html"></th:block>
            <!-- 공통 구조 - main_header end-->

            <!-- 공통 구조 - quick menu -->
            <th:block th:include="/../header/quick_menu.html"></th:block>
            <!-- 공통 구조 - quick menu end -->
            
            <section class="card_box harvesting_sect">
                <div class="card_title_box">
                    <h2 class="card_title">분석 계획 설정</h2>
                    <ul class="card_list_text">
                        <li class="card_top_list">분석 관리 - </li>
                        <li class="card_inner_list">분석 계획 설정 - </li>
                        <li class="card_inner_list">탬플릿 수정</li>
                        <li th:text="' - '+${result.plan.plan_code}"></li>
                    </ul>
                    <div class="print_box on">
                        <button class="form_btn common_btn1 modal_on_btn" data-modal="logModal">변경 이력</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card_cont_box harvesting_add_box"> 
                       <form action="" class="harvesting_form common_form">
                            <div class="form_box task_box select_box">
                                <label for="" class="file_title">과제 정보</label>
                                <select name="" id="" class="task_select common_select" disabled="disabled">
									<th:block th:each="item : ${reportList.list}">
										<option th:value="${item.report_id}" th:selected="${item.report_id} == ${result.plan.report_id}"><span th:text="${item.tot_rsch_start_year}+' - ('+${item.prj_dtl_no}+') '+${item.prj_dtl_nm}"></span></option>
									</th:block>
                                </select>
                            </div>
                            <div class="form_box task_box select_box">
                                <label for="" class="file_title">분석 종류</label>
                                <input type="text" name="" id="" th:value="${result.plan.division_depth_4}" disabled>
                            </div>
                            <div class="form_box task_box select_box">
                                <label for="" class="file_title">품종/유전자원정보</label>
                                <input type="text" name="" id="genetic" th:value="${result.plan.genetic_depth_1}+' > '+${result.plan.genetic_depth_2}" disabled>
                            </div>
                       </form>
                    </div>
                </div>
                <div class="card save_table_card">
                    <div id="analysisGrid"></div>
               </div> 
                <div class="card footer_card">
                    <div class="card_header">
                        <h2 class="header_title">Step1. 일정 및 담당자 지정</h2> <button class="common_btn1 modal_on_btn" data-modal="scheduleContSet">설정</button>
                    </div>
                    <table class="card3_cont_table">
                        <thead>
                            <tr>
                                <th>담당자(정)</th>
                                <th>담당자(부)</th>
                                <th>시작일</th>
                                <th>종료일</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyInfo">
                            <tr>
                                <td><span></span></td>
                                <td><span></span></td>
                                <td><span></span></td>
                                <td><span></span></td>
                            </tr>
                        </tbody>
                   </table>
                </div>
                <div class="card step_3_card on">
                    <div class="card_header">
                        <h2 class="header_title">Step 2 . Comment</h2>
                    </div>
                    <div class="card_cont_box">
                        <form action="" class="common_form">
                            <div class="form_box">
                                <label for="" class="file_title"></label>
                                <textarea name="" id="comment" class="" placeholder="Comment" th:text="${result.plan.plan_contents}"></textarea>
                            </div> 
                        </form>
                    </div>        
                </div>
                <div class="card_footer">
                    <button class="list_btn common_btn1" onclick="location.href='/analysis_plan_list'" >목록</button>
<!--                    <button th:if="${session.LOGIN_MEMBER.account == result.plan.account}" class="save_btn common_btn1">수정</button>-->
                    <button class="save_btn common_btn1">수정</button>
                </div>
            </section>
            
            <!-- 모달 1 -->
            <div class="modal harvesting_modal" id="kindSelect">
                <div class="modal_box">
                    <div class="modal_header">
                        <h2 class="modal_title">분석 항목 조회</h2>
                        <button class="modal_close">닫기</button>
                    </div>
                    <form action="" class="modal_form common_form lookup_form">
                        <div class="select_box modal_input_box">
                            <p for="" class="modal_form_title">품종/유전정보</p>
                            <div class="raido_box_wrap">
                                <div class="radio_box">
                                    <input type="radio" name="kindInfo" id="_kind"> 
                                    <label for="_kind"></label>
                                </div>
                                <div class="radio_box">
                                    <input type="radio" name="kindInfo" id="_genetic">
                                    <label for="_genetic"></label>
                                </div>
                                <div class="radio_box">
                                    <input type="radio" name="kindInfo" id="_etc"> 
                                    <label for="_etc"></label>
                                </div>
                            </div>
                        </div>
                        <div class="select_box modal_input_box">
                            <label for="" class="modal_form_title">용도</label>
                            <select class="common_select" id="">
                                <option value="" hidden>용도 선택</option>
                                <option value="">기능성</option>
                                <option value="">2</option>
                                <option value="">3</option>
                            </select>
                        </div>
                        <div class="select_box modal_input_box">
                            <label for="" class="modal_form_title">분류</label>
                            <select class="common_select" id="">
                                <option value="" hidden>용도 선택</option>
                                <option value="">기능성 관련 성분</option>
                                <option value="">2</option>
                                <option value="">3</option>
                            </select>
                        </div>
                        <div class="form_box modal_input_box off">
                            <label for="" class="modal_form_title">신규 세부 항목</label>
                            <input type="text" id="" class="">
                        </div> 
                    </form>
                    <div class="modal_footer">
                        <button class="common_btn1 modal_btn off">사용</button>
                    </div>
                </div>
            </div>

            <!-- 모달 2 -->
            <div class="modal harvesting_modal scheduleCont_modal" id="scheduleContSet">
                <div class="modal_box">
                    <div class="modal_header">
                        <h2 class="modal_title">일정 및 담당자 설정</h2>
                        <button class="modal_close">닫기</button>
                    </div>
                    <div class="top_cont_box">
                        <div class="cont_left_box cont_list_box" id="plan_manager_list">
                            <span class="file_title">담당자 (정)</span>
                            <table class="main_manager_table manager_table card3_cont_table">
                                <thead>
                                    <tr>
                                        <th><span></span></th>
                                        <th><span>이름</span></th>
                                        <th><span>연구실</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="user : ${userList}">
                                        <td>
                                            <div>
                                                <label for="" class="check_wrap">
                                                    <input type="radio" name="manager" th:value="${user.account}"
                                                           th:username="${user.name}" class="checkbox">
                                                </label>
                                            </div>
                                        </td>
                                        <td>
                                            <span th:text="${user.name}">홍길동</span>
                                        </td>
                                        <td>
                                            <span th:text="${user.groupName}">유용소재연구실</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="manager_name_list"></p>
                        </div>
                        <div class="cont_right_box cont_list_box" id="manager_list">
                            <span class="file_title">담당자 (부)</span>
                            <table class="sub_manager_table manager_table card3_cont_table">
                                <thead>
                                    <tr>
                                        <th><span></span></th>
                                        <th><span>이름</span></th>
                                        <th><span>연구실</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                <tr th:each="user : ${userList}">
                                    <td>
                                        <div>
                                            <label for="" class="check_wrap">
                                                <input type="checkbox" name="subManager" th:value="${user.account}" class="checkbox" th:username="${user.name}">
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <span th:text="${user.name}">홍길동</span>
                                    </td>
                                    <td>
                                        <span th:text="${user.groupName}">유용소재연구실</span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <p class="manager_name_list"></p>
                        </div>
                    </div>
                    <form action="" class="scheduleCont_form common_form">
                        <div class="form_box">
                            <label for="" class="file_title">일정 등록</label>
                            <div class="schedule_date_box">
                                <input type="date" name="start_date" id="start_date" placeholder="시작일">
                                <input type="date" name="end_date" id="end_date" placeholder="종료일">
                            </div>                         
                        </div>
                        <div class="form_box">
                            <label for="" class="file_title">Comment</label>
                            <textarea th:if="${#lists.size(result.schedule) == 0}" name="" id="sch_comment" class="manage_comments"></textarea>
                            <textarea th:if="${#lists.size(result.schedule) != 0}" name="" id="sch_comment" class="manage_comments"
                            th:text="${result.schedule[0].sch_contents}"></textarea>

                        </div>
                    </form>
                    <div class="modal_footer">
                        <button class="common_btn1 modal_btn" id="schedule_save">저장</button>
                    </div>
                </div>
            </div>
            
            <!-- 변경 이력 -->
			 <div class="modal harvesting_modal" id="logModal">
                <div class="modal_box">
                    <div class="modal_header">
                        <h2 class="modal_title">변경 이력 조회</h2>
                        <button class="modal_close">닫기</button>
                    </div>
                    <div class="card sec_card">
                        <div class="card_cont_box">
                            <ul class="change_list_box">
                            	<th:block th:each=" log : ${result.logList}">
	                                <li class="change_list">
	                                    <span class="change_check"></span>
	                                    <div class="chang_text_box">
	                                        <p class="change_text"><span th:text="${log.data_code}"></span> 
	                                        <th:block th:switch="${log.action_type}">
                                                <span th:case="1">등록</span>
                                                <span th:case="2">수정</span>
                                                <span th:case="3">삭제</span>
                                                <span th:case="4">분석 설정</span>
                                                <span th:case="5">시료 분석</span>
                                                <span th:case="6">결과 등록</span>
	                                        </th:block>
	                                        </p>
	                                        <span class="change_date" th:text="${log.log_date}"></span>
	                                    </div>
	                                </li>
                            	</th:block>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
		<th:block th:include="./fragments/commonjs.html"></th:block>
        </main>
        <!-- 공통 구조 - main end -->
    </div>
        <script type="text/javascript" th:inline="javascript">
            let result = [[${result}]];
			console.log(result)
            let stepDataByBatch = [

            ];
            
         	// toast- grid
        	let coldata = JSON.parse(result.plan.template_head);
        	let rowdata = JSON.parse(result.plan.template_body);
        	let checkRow = [];
        	let rowLength;
        	
        	// row key
        	let rowKey = 4;
        	
        	const Grid = tui.Grid;

            let instance = new Grid({
                el: document.getElementById('analysisGrid'), // Container element
                minBodyHeight: 5,
                scrollX: true,
                scrollY: false,
                rowHeaders: ['rowNum'],
                data: rowdata,
                columns: coldata
            });
        	
        		//instance.resetData(newData); // Call API of instance's public method
        	Grid.applyTheme('clean'); // Call API of static method

            $(document).ready(function(){
                const genetic_1 = [[${result.plan.genetic_depth_1}]];
                const genetic_2 = [[${result.plan.genetic_depth_2}]]
                const text = `${genetic_1}(${genetic_1})`
                $('#genetic').val(text)
                // getStepDataByMethodId();
            })

            function getStepDataByMethodId(){
                $.ajax({
                    url : `/api/user/search_user`,
                    method : "GET",
                    dataType : "JSON",
                    success : function(result) {
                        saveScheduleInfo()
                        if (Array.isArray(result?.result)){
                            setStepManagers(result?.result)
                        }
                    },
                    error: (err) => {
                        console.error(err)
                        saveScheduleInfo()
                    }
                })
            }

            function saveScheduleInfo(){
                const saveBtn = document.querySelector('#schedule_save');
                saveBtn.addEventListener('click', (e) => {
                    const batchIndex =  document.querySelector('#scheduleContSet').dataset.batch_index;
                    const stepModal =  document.querySelector('#stepSetting');
                    const trs = stepModal.querySelectorAll('.step_data_row');

                    trs.forEach((tr, index) => {
                        const data = tr.querySelectorAll('td');
                        const supervisor = tr.querySelectorAll('td')[2].innerText
                        const managers = tr.querySelectorAll('td')[3].innerText.split(",");
                        const managerList = []
                        const subMainIds = tr.dataset.sub_manager_ids?.split(",") ?? []

                        const obj = {
                            user_name: "",
                            user_id: 0,
                            mgr_type: 2 //정 1, 부 2
                        }
                        if (tr.dataset.main_manager_id) {
                            managerList.push({
                                ...obj ,
                                user_name: supervisor,
                                mgr_type: 1,
                                user_id: tr.dataset.main_manager_id
                            })
                        }

                        if (subMainIds.length > 0) {
                            subMainIds.forEach((manager, index) => {
                                managerList.push({
                                    ...obj ,
                                    user_name: managers[index],
                                    user_id: manager
                                })
                            })
                        }

                        const rowObj = {
                            index,
                            step_name: data[1].innerText,
                            step_supervisor: data[2].innerText,
                            step_managers: data[3].innerText,
                            batch_index: batchIndex,
                            step_id : tr.dataset.step_id,
                            step_info: data[1].innerText,
                            step_start_date: data[4].innerText,
                            step_end_date: data[5].innerText,
                            managerList,
                            comment: tr.dataset.comment,
                            sub_manager_ids: tr.dataset.sub_manager_ids,
                            main_manager_id: tr.dataset.main_manager_id,

                        }
                        stepDataByBatch[batchIndex][index] = rowObj;
                    })
                    resetStepModal()
                    stepModal.classList.remove('on')
                    document.querySelectorAll('.enroll_btn').forEach(btn => {
                        btn.classList.remove('active');
                    })

                    renderStepSettings()
                    document.querySelector('#main').classList.remove('modal_on');
                })
            }

            function renderStepSettings(){
                const step2TableTr = document.querySelectorAll('.step_2_table tbody tr');
                stepDataByBatch.forEach((data, index) => {
                    if (data[0]?.step_id) {
                        const row = step2TableTr[index].querySelectorAll('td');
                        row[1].innerText = "Step별 설정";
                    }
                })
            }

            function renderStepTable(){
                const stepTable = document.querySelector('.step_2_table tbody');
                stepTable.innerHTML = "";
                const tabCounts = document.querySelectorAll('.setting_top_list').length;
                let htmlStrings = "";
                for (let i = 0; i < tabCounts; i++) {
                    const tr = `
            <tr>
                <td>
                    <div class="add_btn_box">
                        <button class="common_btn1 method_btn enroll_btn">Batch #${i+1}</button>
                        <ul class="add_list_box">
                            <li class="add_list">
                                <button type="button" class="modal_on_btn" data-modal="scheduleContSet">Batch별 설정</button>
                            </li>
                        </ul>
                    </div>
                </td>
                <td title=""></td>
                <td title=""></td>
                <td title=""></td>
                <td title=""></td>
                <td title=""></td>
            </tr>
            `;
                    htmlStrings += tr;
                }
                stepTable.innerHTML = htmlStrings;
                handleEnroll()
                handleScheduleContSet()
            }

            function handleEnroll(){
                const enrollBtn = document.querySelectorAll('.enroll_btn');

                if(enrollBtn) {
                    enrollBtn.forEach(item  => {
                        item.addEventListener('click', () => {
                            let hasenroll = item.classList.contains('active');
                            if (hasenroll) {
                                item.classList.remove('active')
                            } else {
                                item.classList.add('active');
                            }
                        });
                    });
                };
                md7();
            }

            function renderStepModal(isLoad){
                const scheduleContSet = document.querySelector('#scheduleContSet');
                const stepSetting = document.querySelectorAll('#stepSetting tbody tr');
                const batchIndex = scheduleContSet.dataset.batch_index;

                stepSetting.forEach((tr, index) => {
                    if (!stepDataByBatch[batchIndex][index]) return;

                    tr.querySelectorAll('td')[2].innerText = stepDataByBatch[batchIndex][index]?.step_supervisor ?? "";
                    tr.querySelectorAll('td')[3].innerText = stepDataByBatch[batchIndex][index]?.step_managers ?? "";
                    tr.querySelectorAll('td')[4].innerText = stepDataByBatch[batchIndex][index]?.step_start_date ?? "";
                    tr.querySelectorAll('td')[5].innerText = stepDataByBatch[batchIndex][index]?.step_end_date ?? "";
                    tr.dataset.main_manager_id = stepDataByBatch[batchIndex][index].main_manager_id ?? "";
                    tr.dataset.sub_manager_ids = stepDataByBatch[batchIndex][index].sub_manager_ids ?? "";
                    // tr.dataset.index = stepDataByBatch[batchIndex][index].index ?? "";
                    tr.dataset.step_id = stepDataByBatch[batchIndex][index].step_id ?? "";
                    tr.dataset.comment = stepDataByBatch[batchIndex][index].comment ?? "";

                })

            }

            function md7() {
                const lookUpBtn = document.querySelectorAll('.modal_on_btn');
                const modal = document.querySelectorAll('.modal');
                const main = document.getElementById('main');
                const modalCloseBtn = document.querySelectorAll('.modal_close');

                lookUpBtn.forEach((item, index) => {
                    let _has = item.classList.contains('modal_on_btn');
                    let _id = item.getAttribute('data-modal');

                    if(_id !== '' && _has) {
                        let lookupModalId = document.getElementById(_id);
                        let hasOn;
                        let _has = lookupModalId.classList.contains('on');

                        modal.forEach(i => {
                            let an_id = i.getAttribute('id');

                            if(_id !== an_id) {
                                let has = i.classList.contains('on');

                                if(has) {
                                    hasOn = an_id;
                                    return false;
                                };
                                return false;
                            };
                            return false;
                        });

                        lookupModalId.addEventListener('click', (e) => {
                            const target = e.target;
                            if(target.classList.contains('modal') === false) {return};

                            if(hasOn === undefined) {
                                main.classList.remove('modal_on');
                                lookupModalId.classList.remove('on');
                            } else {
                                lookupModalId.classList.remove('on');
                            };
                        });

                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            main.classList.add('modal_on');
                            const scheduleModal =  document.querySelector('#scheduleContSet');
                            if (item?.parentNode?.parentNode?.previousElementSibling?.innerText) {
                                scheduleModal.dataset.batch_index = item.parentNode.parentNode.previousElementSibling.innerText.slice(-1) - 1;
                            }
                            if (item.innerText === "Batch별 설정") {
                                renderScheduleModalByBatch(item);
                                // renderScheduleModalByStep(item)
                            }
                            lookupModalId.classList.add('on');
                            renderStepModal()
                            // renderScheduleModalByStep()
                        });

                        modalCloseBtn.forEach((item) => {
                            item.addEventListener('click', () => {
                                let thisModal = item.parentNode.parentNode.parentNode;
                                thisModal.classList.remove('on');

                                if(hasOn !== undefined) {
                                    main.classList.remove('modal_on');
                                    return false;
                                };
                            });
                        });

                    } else {
                        return;
                    }
                });

            };

            function renderScheduleModalByBatch(target){
                const data = target.parentNode.parentNode.parentNode.parentNode.parentNode;
                renderScheduleModalByStep(data)
            }

            function renderScheduleModalByStep(target){
                const supervisor = target.dataset.main_manager_id
                const managers = target.dataset.sub_manager_ids?.split(",")
                const startDate = target.querySelectorAll('td')[4].innerText;
                const endDate = target.querySelectorAll('td')[5].innerText;
                const scheduleContSet = document.querySelector('#scheduleContSet');
                const planMangerList = scheduleContSet.querySelector('#plan_manager_list .manager_name_list');
                const manager_list = scheduleContSet.querySelector('#manager_list .manager_name_list');

                if (!managers) return;
                scheduleContSet.querySelectorAll('.main_manager_table tbody tr').forEach(tr => {
                    const trId = tr.dataset.user_id;
                    if (trId === supervisor) {
                        tr.querySelector('.checkbox').checked = true;
                        const data = tr.querySelectorAll('td');
                        planMangerList.innerText = `${data[1].querySelector('span').innerText}(${data[2].querySelector('span').innerText})`;
                    }

                })
                let listString = "";
                scheduleContSet.querySelectorAll('.sub_manager_table tbody tr').forEach(tr => {
                    const trId = tr.dataset.user_id;
                    if (managers.some(el => el === trId)) {
                        tr.querySelector('.checkbox').checked = true;
                        const data = tr.querySelectorAll('td');
                        listString +=`${data[1].querySelector('span').innerText}(${data[2].querySelector('span').innerText}),`;
                    }
                })
                manager_list.innerText = listString;

                scheduleContSet.querySelector('input[name="start_date"]').value = startDate;
                scheduleContSet.querySelector('input[name="end_date"]').value = endDate;
                scheduleContSet.querySelector('.manage_comments').value = target.dataset.comment
            }

            function setCheckboxEventHandler(){
                const planMangerList = document.querySelector('#plan_manager_list');
                planMangerList.querySelectorAll('.checkbox').forEach((input, index) => {
                    input.addEventListener('change', (e) => {
                        const target = e.currentTarget;
                        if (target.checked) {
                            const data = target.parentNode.parentNode.parentNode.parentNode.querySelectorAll('td');
                            planMangerList.querySelector('.manager_name_list').innerText = `${data[1].innerText}(${data[2].innerText})`;
                        }
                        checkModalInput()
                    })
                })

                const manager_list = document.querySelector('#manager_list');
                manager_list.querySelectorAll('.checkbox').forEach((input, index, arr) => {
                    input.addEventListener('change', (e) => {
                        let listString = "";
                        arr.forEach((el, i) => {
                            const data = el.parentNode.parentNode.parentNode.parentNode.querySelectorAll('td');
                            if (el.checked) {
                                listString +=`${data[1].innerText}(${data[2].innerText}),`;
                            }
                            checkModalInput()
                        })

                        manager_list.querySelector('.manager_name_list').innerText = listString.slice(0, -1)
                    })
                })
            }

            function handleScheduleContSet(){
                setCheckboxEventHandler()
                setInputEventHandler()
            }

            function resetStepModal(){
                const stepModal =  document.querySelector('#stepSetting');
                const trs = stepModal.querySelectorAll('.step_data_row');
                trs.forEach((tr, index) => {
                    const data = tr.querySelectorAll('td');
                    data[2].innerText = "";
                    data[3].innerText = "";
                    data[4].innerText = "";
                    data[5].innerText = "";
                    tr.dataset.main_manager_id = "";
                    tr.dataset.sub_manager_ids = "";
                    tr.dataset.comment = "";
                })
            }

            function setStepManagers(list) {
                let html = "";
                let html2 = "";
                list.forEach((manager) => {
                	
                	let groupArr = manager.groupName.split('/');
        			let groupName = groupArr[groupArr.length-1]
                	
                    const tr = `
            <tr data-user_id="${manager?.account}">
                <td>
                    <div>
                        <label for="" class="check_wrap">
                            <input type="radio" name="kindInfo" id="" class="checkbox">
                        </label>
                    </div>
                </td>
                <td>
                    <span>${manager?.name}</span>
                </td>
                <td>
                    <span>${groupName}</span>
                </td>
            </tr>
            `;
                    html += tr;
                    const tr2 = `
            <tr data-user_id="${manager?.account}">
                <td>
                    <div>
                        <label for="" class="check_wrap">
                            <input type="radio" id="" class="checkbox">
                        </label>
                    </div>
                </td>
                <td>
                    <span>${manager?.name}</span>
                </td>
                <td>
                    <span>${groupName}</span>
                </td>
            </tr>
            `;
                    html2 += tr2;
                })
                const mainManagerTable = document.querySelector('.main_manager_table tbody');
                const subManagerTable = document.querySelector('.sub_manager_table tbody');
                mainManagerTable.innerHTML = html;
                subManagerTable.innerHTML = html2;
                console.log("test")

            }

        </script>


        <script th:inline="javascript" type="text/javascript">

            $(document).ready(function(){

                let result = [[${result}]];

                if(result.schedule.length != 0){
                    let schedule = result.schedule[0];

                    $("#start_date").val(schedule.start_date);
                    $("#end_date").val(schedule.end_date);

                    let subManagerList = [];
                    schedule.managerList.map((v, i) => {
                        if(v.mgr_type == 1){
                            $(":radio[name='manager'][value='" + v.account + "']").attr('checked', true);
                        }else{
                            subManagerList.push(v);
                        }
                    })

                    subManagerList.map(subManager => {
                        $("input[name=subManager][value="+subManager.account+"]").prop("checked",true);
                    })


                    ////////////////
                    $("#tbodyInfo").empty();
                    let managerName = "";
                    let subManagerName = "";

                    schedule.managerList.map((v, i) => {
                        if(v.mgr_type == 1){
                            managerName = v.user_name;
                        }else{
                            subManagerName += v.user_name + ",";
                        }
                    })
                    if(subManagerName.length != 0){
                        subManagerName = subManagerName.substring(0, subManagerName.length - 1);
                    }
                    let tr =
                        `
                            <tr>
                                <td>${managerName}</td>
                                <td>${subManagerName}</td>
                                <td>${schedule.start_date}</td>
                                <td>${schedule.end_date}</td>
                            </tr>
                        `
                    $("#tbodyInfo").append(tr);
                }

            });

            function modalValCheck(){
                let manager = $(':radio[name="manager"]:checked').val();
                if(manager == undefined){
                    alert("담당자 (정) 를 선택해주세요");
                    return false;
                }

                let subManager = "";
                $("input[name=subManager]:checked").each(function() {
                    subManager += subManager += $(this).val();
                });
                if(subManager == ""){
                    alert("담당자 (부) 를 선택해주세요");
                    return false;
                }

                let startDate = $("#start_date").val();
                if(startDate == ''){
                    alert("시작일을 선택해주세요");
                    return false;
                }

                let endDate = $("#end_date").val();
                if(endDate == ''){
                    alert("종료일을 선택해주세요");
                    return false;
                }

                return true;
            }

            $("#schedule_save").on('click', function() {

                if(!modalValCheck()){
                    return;
                }

                let manager_id = $(':radio[name="manager"]:checked').attr('username');
                let sub_manager_id = "";
                $("input[name=subManager]:checked").each(function() {
                    sub_manager_id += $(this).attr('username') + ",";
                });
                sub_manager_id = sub_manager_id.substring(0, sub_manager_id.length - 1);
                let start_date = $("#start_date").val();
                let end_date = $("#end_date").val();

                $("#tbodyInfo").empty();

                let tr =
                    `
                            <tr>
                                <td>${manager_id}</td>
                                <td>${sub_manager_id}</td>
                                <td>${start_date}</td>
                                <td>${end_date}</td>
                            </tr>
                        `

                $("#tbodyInfo").append(tr);

                $('#scheduleContSet').removeClass('on');
                $('#main').removeClass('modal_on');
            });

            $(".save_btn").on('click', function (){

                if(!modalValCheck()){
                    return;
                }

                let plan_id = [[${result.plan.plan_id}]]
                let plan_code = [[${result.plan.plan_code}]]
                let manager_id = $(':radio[name="manager"]:checked').val();
                let sub_manager_id = "";
                $("input[name=subManager]:checked").each(function() {
                    sub_manager_id += $(this).val() + ",";
                });
                sub_manager_id = sub_manager_id.substring(0, sub_manager_id.length - 1);
                let sch_comment = $('#sch_comment').val();
                let start_date = $("#start_date").val();
                let end_date = $("#end_date").val();
                let comment = $("#comment").val();

                $.ajax({
                    url:'/analysis/modify-plan-template',
                    method:'POST',
                    data:{
                        'manager_id' : manager_id,
                        'sub_manager_id' : sub_manager_id,
                        'sch_comment' : sch_comment,
                        'start_date' : start_date,
                        'end_date' : end_date,
                        'comment' : comment,
                        'plan_id' : plan_id,
                        'plan_code' : plan_code
                    },
                    success : function(result){
                        alert("수정에 성공하셨습니다.");
                        location.reload();
                    }
                })

            });
            
         // 날짜 선택
    		$('input[type="date"]').on('change', function(e) {
    			
    			let start = $('#start_date').val();
    			let end = $('#end_date').val();
    			let startDate = new Date(start);
    			let endDate = new Date(end);
    			
    			if (isEmpty(end)) {
    				document.getElementById('end_date').valueAsDate = startDate;
    			}else if(isEmpty(start)){
    				document.getElementById('start_date').valueAsDate = endDate;
    			}else if(e.target.id == 'end_date' && (endDate - startDate) < 0){
    				document.getElementById('start_date').valueAsDate = endDate;	
    			}else if(e.target.id == 'start_date' && (endDate - startDate) < 0){
    				document.getElementById('end_date').valueAsDate = startDate;	
    			}
    			
    		});
    		
    		// 빈값 확인
    		let isEmpty = (val) => {
    			if(val === '' || val === null || val === undefined || (val !== null && typeof val === 'object' && !Object.keys(val).legth)){
    				return true;
    			}else{
    				return false;
    			}
    		}

        </script>
</body>
</html>