<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/html"
	xmlns="http://www.w3.org/1999/html">
<head>
<th:block th:include="./fragments/header.html"></th:block>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- 파비콘 -->
<link rel="icon" href="/favicon.ico">
<!-- <link rel="icon" href="../../static/favicon.ico"> -->
<title>Digital Lab - 시료 분석</title>
<link rel="stylesheet" href="/css/common/reset.css">
<link rel="stylesheet" href="/css/common/common.css">
<link rel="stylesheet" href="/css/common/ui.css">
<link rel="stylesheet" href="/css/style/sample_analysis_2.css">

<script src="/js/common/jquery-3.6.0.js"></script>
<script src="/js/common/loadHeader.js"></script>
<script src="/js/common/common.js"></script>
<script src="/js/sample_analy_modify.js"></script>
<script src="/js/Error.js"></script>

<!-- <link rel="stylesheet" href="../../static/css/common/reset.css">
    <link rel="stylesheet" href="../../static/css/common/common.css">
    <link rel="stylesheet" href="../../static/css/common/ui.css">
    <link rel="stylesheet" href="../../static/css/style/sample_analysis_2.css">
    
    <script src="../../static/js/common/jquery-3.6.0.js"></script>
    <script src="../../static/js/common/loadHeader.js"></script>
    <script src="../../static/js/common/common.js"></script>
    <script src="../../static/js/sample_analy_modify.js"></script>
    <script src="../../static/js/Error.js"></script> -->
<style>
.analysis_box .info_list_wrap .info_list {
	border: none;
}

.info_list>div {
	border-left: 1px solid #D9D9D9;
	border-top: 1px solid #D9D9D9;
	border-right: 1px solid #D9D9D9;
}

.info_list>div:last-child {
	border-bottom: 1px solid #D9D9D9;
}

#wrap #main .sample_analysis_sect .step_1_card.on.active {
	height: 970px;
}

#main .method_comment_box .place_date_text {
	color: #7C8798;
	font-weight: 700;
	line-height: 40px;
}

#main .method_comment_box .place_date_list_box {
	background-color: rgba(59, 59, 59, 0.05);
}

.work_step_box input[type="text"] {
	width: 100%;
}
</style>
</head>
<body>
	<div id="wrap">
		<!-- 공통 구조 - header -->
		<div id="header">
			<th:block th:include="/../header/header.html"></th:block>
		</div>
		<!-- 공통 구조 - header end -->

		<!-- 공통 구조 - main -->
		<main id="main">
			<!-- 공통 구조 - main_header -->
			<th:block th:include="/../header/main_header.html"></th:block>
			<!-- 공통 구조 - main_header end-->

			<!-- 공통 구조 - quick menu -->
			<th:block th:include="/../header/quick_menu.html"></th:block>
			<!-- 공통 구조 - quick menu end -->

			<section class="card_box sample_analysis_sect">
				<div class="card_title_box">
					<h2 class="card_title">시료 분석</h2>
					<ul class="card_list_text">
						<li class="card_top_list">분석 관리 -</li>
						<li class="card_inner_list">시료 분석 -</li>
						<li class="card_inner_list">고급 등록</li>
					</ul>
					<div class="print_box on">
						<button class="form_btn common_btn1 modal_on_btn" data-modal="logModal">변경 이력</button>
					</div>
				</div>
				<div class="card first_card">
					<div class="card_header">
						<h2 class="header_title">분석 결과 등록</h2>
					</div>
					<div class="card_cont_box">
						<div class="place_date_box">
							<p class="place_date_text">배치별 입력 가능 일자</p>
							<ul class="place_date_list_box">
								<th:block th:each="plate : ${result.plate}">
									<li class="place_date_list"><span class="batch_name">Batch
											[[${plate.plate_index}]] : </span><span class="place_date1">[[${plate.start_date}]]</span>
										~ <span class="place_date2">[[${plate.end_date}]]</span></li>
								</th:block>
							</ul>
						</div>
						<ul class="step_list_box" id="step_list">
							<!-- done, ready 처리 -->
							<th:block th:if="${result.step} != null">
								<th:block th:each="step , i : ${result.step}">
									<li th:data-step="${step.step_id}"
										th:data-name="${step.step_id}" th:data-index="${i.count - 1}"
										class="step_list"
										th:classappend="${step.step_id == result.plan.plan_step} ? 'done'">Step
										[[${i.count}]]</li>
								</th:block>
							</th:block>
						</ul>

						<div class="place_date_box method_comment_box">
							<p class="place_date_text">실험방법 step - Comment</p>
							<ul class="place_date_list_box">
								<li class="place_date_list"><span class="method_comment"></span>
								</li>
							</ul>
						</div>


						<!-- <div class="method_comment_box common_form">
                            <div class="form_box">
                                <label for="" class="file_title">메소드 step - Comment</label>
                                <textarea name="" id="" class="" placeholder="" disabled>메소드 step - Comment</textarea>
                            </div> 
                        </div> -->


						<div class="sample_analysis_table_box">

							<div class="setting_top_box">
								<ul class="setting_top_list_box" id="plate_list">
									<th:block th:each="plate : ${result.plate}">
										<li class="setting_top_list"
											th:data-grid="'plateGrid_' + ${plate.plate_index}"
											th:data-plate="${plate.plate_id}"
											th:data-setting="'Batch_' + ${plate.plate_index}"
											th:classappend="${plate.plate_id} == ${result.plan.plan_plate} ? 'active'"
											onclick="onClickBatchTabBtn(event)">Batch
											#[[${plate.plate_index}]]</li>
									</th:block>
								</ul>
							</div>


							<!-- 
                            목록 버튼, batch 버튼 활성화 비활성화 구분 속성                         
                            .bottom_setting 안에 데이터 속성 생성
                            data-list="", data-down="" 2개다 넣어야함

                            data-list="true" -> 목록버튼 활성화
                            data-down="true" -> batch 버튼 활성화

                            data-list="false" -> 목록버튼 비활성화
                            data-down="false" -> batch 버튼 비활성화
                            -->

							<th:block th:each="plate : ${result.plate}">
								<div class="sample_analysis_box bottom_setting"
									th:data-grid="'plateGrid_' + ${plate.plate_index}"
									th:id="'Batch_' + ${plate.plate_index}">
									<div th:id="'plateGrid_' + ${plate.plate_index}"
										th:data-plate="${plate.plate_id}"></div>
								</div>
							</th:block>

							<div id="excelGrid" style="display: none"></div>


							<!-- 사진나오는 모달 버튼 -->
							<!-- <button type="button" class="photo_btn modal_on_btn" data-modal="_photoModal">dsadsa</button> -->


							<div
								class="card_sect_footer cont_footer_btnbox method_footer_btnbox"
								data-footer="Batch_1">
								<button type="button" class="common_btn1 list_btn">목록</button>
								<button type="button" class="common_btn1 download_btn"
									style="display: none; margin-top: 20px;">다운로드</button>
								<div class="add_btn_box" style="margin-top: 20px;">
									<button class="common_btn1 method_btn enroll_btn">저장</button>
									<ul class="add_list_box" style="z-index: 9999">
										<li class="add_list" onclick="saveStepData()"><a href="#">스텝 저장</a></li>
										<li class="add_list" onclick="saveBatchData()"><a
											href="#">Batch 완료</a></li>
										<li class="add_list" onclick="saveAllData()"><a>전체 완료</a>
										</li>
									</ul>
								</div>
							</div>
							<div
								class="card_sect_footer cont_footer_btnbox method_footer_btnbox"
								data-footer="Batch_2">
								<button type="button" class="common_btn1 list_btn">목록</button>
								<button type="button" class="common_btn1 download_btn"
									style="display: none; margin-top: 20px;">다운로드</button>
								<div class="add_btn_box" style="margin-top: 20px;">
									<button class="common_btn1 method_btn enroll_btn">저장</button>
									<ul class="add_list_box" style="z-index: 9999; top: 60px;">
										<li class="add_list" onclick="saveStepData()"><a href="#">스텝 저장</a></li>
										<li class="add_list" onclick="saveBatchData()"><a
											href="#">Batch 완료</a></li>
										<li class="add_list" onclick="saveAllData()"><a>전체 완료</a></li>
									</ul>
								</div>
							</div>
							<div
								class="card_sect_footer cont_footer_btnbox method_footer_btnbox"
								data-footer="Batch_3">
								<button type="button" class="common_btn1 list_btn">목록</button>
								<button type="button" class="common_btn1 download_btn"
									style="display: none; margin-top: 20px;">다운로드</button>
								<div class="add_btn_box" style="margin-top: 20px;">
									<button class="common_btn1 method_btn enroll_btn">저장</button>
									<ul class="add_list_box" style="z-index: 9999">
										<li class="add_list" onclick="saveStepData()"><a href="#">스텝 저장</a></li>
										<li class="add_list" onclick="saveBatchData()"><a
											href="#">Batch 완료</a></li>
										<li class="add_list" onclick="saveAllData()"><a>전체 완료</a>
										</li>
									</ul>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- 숨겨진 card 섹션에 on, active 클라스 적용 -->
				<div class="card step_1_card on" id="analysis_plan_info">
					<div class="card_header">
						<h2 class="header_title">분석 계획 정보</h2>
					</div>
					<div class="card_cont_box">
						<form action="" class="sample_analysis_form common_form">
							<div class="analysis_box">
								<div class="form_box disabled_box">
									<label for="" class="file_title">분석 번호</label> <input
										type="text" name="" id="" th:value="${result.plan.plan_code}"
										disabled>
								</div>
								<div class="form_box disabled_box task_info_box">
									<label for="" class="file_title">과제 정보</label> <input
										type="text" name="" id="plan_info"
										th:value="${result.plan.prj_dtl_no}+' - '+${result.plan.prj_nm} "
										disabled>
								</div>
								<div class="form_box list_box">
									<ul class="info_list_wrap">

									</ul>
								</div>
							</div>
							<div class="analysis_box">
								<div class="form_box disabled_box">
									<label for="" class="file_title">분석 항목</label> <input
										type="text" name="" id=""
										th:value="${result.plan.division_depth_4}" disabled>
								</div>
								<div class="form_box disabled_box work_step_box">
									<label for="" class="file_title">작업 단계</label>
									<th:object th:if="${result.plan.method_stage == 1}">
										<input type="text" name="" id="" value="전처리" disabled>
									</th:object>
									<th:object th:if="${result.plan.method_stage == 2}">
										<input type="text" name="" id="" value="시료 분석" disabled>
									</th:object>
								</div>
								<div class="form_box disabled_box">
									<label for="" class="file_title">시료수</label> <input type="text"
										name="" id="" th:value="${result.plan.seed_ammount}" disabled>
								</div>
								<div class="form_box disabled_box">
									<label for="" class="file_title">반복수</label> <input type="text"
										name="" id="" th:value="${result.plan.method_cycle}" disabled>
								</div>
								<div class="form_box disabled_box">
									<label for="" class="file_title">생성일</label> <input type="text"
										name="" id="" th:value="${result.plan.create_date}" disabled>
								</div>
								<div class="bottom_form_box">
									<div class="form_box disabled_box">
										<label for="" class="file_title">User 96Well</label> <input
											type="text" name="" id="" th:value="${result.plan.plan_well == 1 ? 'Y' : 'N' }" disabled>
									</div>
									<div class="form_box disabled_box">
										<label for="" class="file_title">Batch No</label> <input
											type="text" name="" id=""
											th:value="${result.plan.plan_batch}" disabled>
									</div>
									<div class="form_box disabled_box">
										<label for="" class="file_title">Sample No / Batch</label> <input
											type="text" name="" id=""
											th:value="${result.plan.plan_sample}" disabled>
									</div>
									<div class="form_box disabled_box">
										<label for="" class="file_title">Blanck No</label> <input
											type="text" name="" id=""
											th:value="${result.plan.plan_blank}" disabled>
									</div>
									<div class="form_box disabled_box">
										<label for="" class="file_title">Standard No</label> <input
											type="text" name="" id=""
											th:value="${result.plan.plan_standard}" disabled>
									</div>
									<div class="form_box disabled_box">
										<label for="" class="file_title">Control No</label> <input
											type="text" name="" id=""
											th:value="${result.plan.plan_control}" disabled>
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>
				<div class="card step_3_card on">
					<div class="card_header">
						<h2 class="header_title">Comment</h2>
					</div>
					<div class="card_cont_box">
						<form action="" class="common_form">
							<div class="form_box">
								<label for="" class="file_title"></label>
								<textarea name="" id="" class="" placeholder="Comment"
									th:text="${result.plan.plan_contents}"></textarea>
							</div>
						</form>
					</div>
				</div>
				<div class="card_footer">
					<button class="list_btn common_btn1">목록</button>
				</div>
			</section>

			<!-- 사진등록 모달 -->
			<div class="modal harvesting_modal photo_modal" id="_photoModal">
				<div class="modal_box">
					<div class="modal_header">
						<h2 class="modal_title">사진</h2>
						<button class="modal_close">닫기</button>
					</div>
					<ul class="photo_box" id="modalImgWrap">

					</ul>
					<div class="modal_footer">
						<input type="file" id="photo_fileUp"
							onchange="onChangeModalImage(this)" style="display: none;">
						<label for="photo_fileUp" class="common_btn1 modal_btn">사진</label>
						<button class="common_btn1 modal_btn" onclick="onClickModalSave()">저장</button>
					</div>
				</div>
			</div>

			<!-- 변경 이력 -->
			 <div class="modal harvesting_modal" id="logModal">
                <div class="modal_box on">
                    <div class="modal_header">
                        <h2 class="modal_title">변경 이력 조회</h2>
                        <button class="modal_close">닫기</button>
                    </div>
                    <div class="card sec_card">
                        <div class="card_cont_box">
                            <ul class="change_list_box">
                            	
                            	<th:block th:each=" log : ${result.logList}">
	                                <li class="change_list">
	                                    <span class="change_check"></span>
	                                    <div class="chang_text_box">
	                                        <p class="change_text"><span th:text="${log.data_code}"></span> 
	                                        <th:block th:switch="${log.action_type}">
	                                        		<span th:case="1">등록</span>
													<span th:case="2">수정</span>
													<span th:case="3">삭제</span>
													<span th:case="4">분석 설정</span>
													<span th:case="5">시료 분석</span>
													<span th:case="6">결과 등록</span>
	                                        </th:block>
	                                        </p>
	                                        <span class="change_date" th:text="${log.log_date}"></span>
	                                    </div>
	                                </li>
                            	</th:block>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

			<!-- 모달 2 -->
			<div class="modal harvesting_modal" id="_subStepModal">
				<div class="modal_box">
					<div class="modal_header">
						<h2 class="modal_title">시료분석 서브 스텝</h2>
						<button class="modal_close">닫기</button>
					</div>

					<div id="subStepGrid"></div>

					<div class="modal_footer" style="margin-top: 20px">
                        <button type="button" class="common_btn1 modal_btn" onclick="saveSubStepData();">저장</button>
                    </div>
				</div>
			</div>

		</main>
		<th:block th:include="./fragments/commonjs.html"></th:block>
		<!-- 공통 구조 - main end -->
	</div>


	<script>
        const card = document.querySelectorAll('.card');

        card.forEach((item, idx) => {
            let header = item.firstElementChild;
            
            if(idx > 0) {
                header.addEventListener('click', () => {
                    let has = item.classList.contains('active');
                    let active = has ? item.classList.remove('active') : item.classList.add('active');
                });
            };
        });   
    </script>

	<script th:inline="javascript" type="text/javascript">
        //import {check} from "../../static/tui-grid";

        const result = [[${result}]]
        const plan_well = result.plan.plan_well == 1 ? true : false;
        const frozenCount = plan_well ? 5 : 3;
        
        console.log(result , "result");
        
        if (result) {
            const { geneticData, plan, batch, schedule } = result;
            const geneticBox = document.querySelector('.analysis_box .info_list_wrap');
            if (Array.isArray(geneticData)) {
                let htmlStrings = "";
                let arr = [];
                geneticData.forEach((data, sampleIndex) => {
                    let list = "";
                    const checkDupli = [];
                    data.geneticList.forEach((el, index) => {
                        if (checkDupli.some(check => check === el?.genetic)) {
                            return;
                        } else {
                            checkDupli.push(el.genetic)
                            list += `<div>${el.genetic}</div>`;
                        }
                    });

                    const html = `
                        <li class="info_list">
                            <div>${data?.parent_name}</div>
                            ${list}
                        </li>
                    `;
                    htmlStrings += html;
                    arr = arr.concat(data.geneticList);
                })
                geneticBox.innerHTML = htmlStrings;
            }

            if(plan.seedList) {
                const data = plan.seedList[0];
                //document.querySelector('#plan_info').value = `${data.report_code ?? ""} - ${data.report_name ?? ""}`;
            }
        }

        $(document).ready(function(){
            const plate_id = getSelectedPlateId();
            const selectedStep = document.querySelector('#step_list > .step_list.done');
            const selectedPlate = document.querySelector('#plate_list > .setting_top_list.active');
            const selectedPlateId = [[${result.plan.plan_plate}]];
            selectedPlate?.click();
            if(selectedPlateId == -1 || selectedPlate == null){
                const firstPlate = document.querySelector('#plate_list > .setting_top_list');
                firstPlate.classList.add('active')
                console.log(firstPlate);
                firstPlate.click()
            }

            selectedStep?.click();
            createGrid(plate_id);
            $('.download_btn').removeClass('off');
        });
        let gridMap = new Object();
        let excelGrd = null;
        let sub_plate_id = -1;

        let ansyncFlag = true;
        
        function createGrid(grid_id){
            return new Promise((resolve, reject) => {
            	
            	if(grid_id == -1){
            		return false;
            	}
            	
                let gridElement = document.getElementById(grid_id);
                
                let plate_id = gridElement.dataset.plate;
                
                // 서브스텝 플레이트 아이디
                sub_plate_id = plate_id;
                
                console.log(plate_id , "plate_id")
                
                width : 2400,
                
                $.ajax({
                    url: '/api/batch-plate',
                    method: 'GET',
                    dataType:"JSON",
                    data : {
                        'plate_id' : plate_id,
                    },
                    success : function(result){
                    	
                        if(!gridMap[grid_id]) {
                            gridMap[grid_id] = new tui.Grid({
                                el : gridElement,
                                scrollY: true,
                                scrollX: true,
                                data: result.list,
                                rowHeaders: ['rowNum'],
                               	editingEvent: 'click',
                                columns: [],
                                columnOptions: {
                                    frozenCount: frozenCount,
                                    frozenBorderWidth: 2,
                                    minWidth: 100
                                },
                                bodyHeight: 500,
                                pageOptions: {
                                    useClient: true,
                                    type: 'scroll',
                                    perPage: 20
                                },
                                header : {}
                            });

                            const step = getSelectedStepData();
                            const step_id = step?.step ?? -1;
                            
                            let conplexArr = createComplexList(step_id);
                            let headerArr = createHeaderList(step_id);
                            
                            gridMap[grid_id].setHeader(conplexArr)
                            gridMap[grid_id].setColumns(headerArr);
                            gridMap[grid_id].resetData(result.list);

                            gridMap[grid_id].on('click', (ev) => {
                            	
                                if(ev.targetType == 'columnHeader'){
                                    const stepList = [[${result.step}]];
                                    let step_id = -1;
                                    let subCheck = '';
                                    
                                    stepList.forEach(step => {
                                        if(ev.columnName == step.step_id){
                                            step_id = step.step_id;
                                        }
                                        
                                        if(ev.columnName == step.step_id+'-sub'){
                                        	subCheck = ev.columnName;
                                        	step_id = step.step_id;
                                        }
                                    })
                                    
                                    if(subCheck != ''){
                                    	getSubStepGrid(step_id)
                                    }else if(step_id != -1){
                                        getStepImage(step_id);
                                    }
                                    
                                }

                            })

                            gridMap[grid_id].on('editingStart', (ev) =>{
                                const key = getSelectedPlateId();
                                const bach_id = gridMap[key].getRow(ev.rowKey).batch_id;
                                const step_data = getSelectedStepData();
                                $.ajax({
                                    url:"/check/batch",
                                    async:false,
                                    method:"GET",
                                    dataType:"JSON",
                                    data:{
                                        "batch_id":bach_id,
                                        "step_id":step_data.step,
                                    },
                                    success : function (result){
                                    	
                                    	console.log(result , "result")
                                    	
                                        if(!result)
                                            ev.stop();
                                    }
                                })

                                return false;
                            })
                            gridMap[grid_id].on('beforeExport', async ev => {
                            	ev.stop();
                                await exportExcel(ev,headerArr);
                            });
                            
                        }
                        resolve("123");
                        ansyncFlag = false;
                    },
                    error : function(result){
                        ansyncFlag = false;
                    }
                })

            })
        }
	
        function createHeader1(header, name){
            let headerData = {"header" : header == null ? name : header, "name" : name };

            return headerData;
        }
        
        function createHeader2(header, name, check = false, step_id = -1){
            let headerData = {"header" : header == null ? name : header, "name" : step_id, "width" : "200", "step_id" : step_id};
            
            if(check){
                 headerData.editor="text";
            }
            return headerData;
        }
        
        function addStepEventListner(){
            const step = document.querySelectorAll('#step_list .step_list');
            step.forEach(item => {
                item.addEventListener('click', (e) => {
                    onClickStep(e);
                })
            })
        }

        function onClickStep(e){
            $('#step_list .step_list').removeClass('done');
            const step = e.currentTarget;
            step.classList.add('done');
			
            const step_id = step.dataset.step;

            const plate_id = getSelectedPlateId();
            const plate = document.getElementById(plate_id);
            let scrollDiv = plate.querySelectorAll('.tui-grid-body-area')[1];
            const name = step.dataset.name;
            const step_index = step.dataset.index;
            const column = plate.querySelectorAll('th')[step_index];
            console.log(plate , "plate")
			console.log(step_index , "step_index")
            console.log(column , "column");
            
            setTimeout(() => {
                scrollDiv.scrollLeft = column.offsetLeft;
            }, 10)

            console.log(scrollDiv);
            setEditStep(step_id);
        }

        function setEditStep(step_id){
            const headerList = createHeaderList(step_id);
            const grid_id = getSelectedPlateId();
            gridMap[grid_id].setColumns(headerList);

        }
		
        function createComplexList(step_id = -1){
        	let complexColumn = {height: 70 , complexColumns : []};
        	let complexList = []
        	const stepList = [[${result.step}]];
        	
        	stepList.forEach(step =>{
                
        		let header = '';
        		let name = '';
        		if(step.sub_step_list.length > 0){
        			header = 'sub';
        			name = step.step_id+'-sub';
        		}
        		
              	let gridComplex = columnComplex(step.step_id , header, name);
                
                complexList.push(gridComplex);
            })
			complexColumn['complexColumns']	= complexList;
            
            return complexColumn;
        }
        
        function columnComplex( step_id , header , name){
        	
        	let object = {
        					header: header,
                   	 		name: name,
                   	 		childNames: [step_id]
        				}
        	
        	return object;
        }
        
        function createHeaderList(step_id = -1){
            let headerList = [];
            headerList.push(createHeader1("작목 명", "genetic_depth_1"));
            headerList.push(createHeader1("품정 유전자원 명", "genetic_depth_2"));
            headerList.push(createHeader1("Sample ID","batch_sample"));
            if(plan_well){
    	        headerList.push(createHeader1("Test ID", "batch_test"));
	            headerList.push(createHeader1("Well No", "batch_well"));
            }
            const stepList = [[${result.step}]];
            stepList.forEach(step =>{
                let flag = step_id == step.step_id;
                
                console.log(step , "step")
                
              	let gridHeader = createHeader2(step.step_nickName,step.step_name,flag,step.step_id);
                
                headerList.push(gridHeader);
            })
			
            return headerList;
        }
        
        let subStepData = null;
        
        function createSubHeaderList(step_id){
        	let headerList = [];
            headerList.push(createHeader1("작목 명", "genetic_depth_1"));
            headerList.push(createHeader1("품정 유전자원 명", "genetic_depth_2"));
            headerList.push(createHeader1("Sample ID","batch_sample"));
            if(plan_well){
    	        headerList.push(createHeader1("Test ID", "batch_test"));
	            headerList.push(createHeader1("Well No", "batch_well"));
            }
            const stepList = [[${result.step}]];
            
            stepList.forEach(step =>{
                let flag = step_id == step.step_id;
                
                if(flag){
                	
                	subStepData = step.sub_step_list;
                	step.sub_step_list.forEach((sub) => {
                		
		              	let gridHeader = createHeader2(sub.step_nickName,sub.step_name,flag,sub.step_id);
		                
		                headerList.push(gridHeader);
                	})
                }
            })
            
        	return headerList;
        }
        
        function onClickBatchTabBtn(event){
            let target = event.currentTarget;
            console.log(target);
            let grid_id = target.dataset.grid;
            createGrid(grid_id);
        }

        // 분석 계획 정보 렌더
        function getAnalysisPlan(){
            // const document.querySelector("analysis_plan_info")
        }

        $(document).ready(function(){
            addStepEventListner();
        });
        
        function saveSubStepData(){
        	const plate_id = getSelectedPlateId();
        	const data = subGrid.getData();
        	
        	let modifyedData = subGrid.getModifiedRows().updatedRows;
            let batchList = [];
            modifyedData.forEach(row => {
            	
            	let object = new Object();
            	
            	subStepData.forEach((item) => {
					if(row[item.step_id])
                    	object[item.step_id] = row[item.step_id];
            	})
            	
                row.batch_data = JSON.stringify(object);
                subGrid.setValue(row.rowKey, 'batch_data',row.batch_data);

                let batch_data = new Object();
                batch_data.batch_sub_id = row.batch_sub_id;
                batch_data.batch_id = row.batch_id;
                batch_data.batch_data = JSON.stringify(object);
                batchList.push(batch_data);
            })
            
            console.log(batchList , "batchList")
            ajaxSubStepSave( batchList , subStep_id)
        }

        function saveStepData(){
            const plate_id = getSelectedPlateId();
            const data = gridMap[plate_id].getData();

            const stepData = getSelectedStepData();
            if(stepData == null)
                return;
            const step_name = stepData.name;

            let modifyedData = gridMap[plate_id].getModifiedRows().updatedRows;
            
            let batchList = [];
            modifyedData.forEach(row => {
                let object = new Object();
                if(row.batch_data)
                    object = JSON.parse(row.batch_data);
                object[step_name] = row[step_name];
                row.batch_data = JSON.stringify(object);
                gridMap[plate_id].setValue(row.rowKey, 'batch_data',row.batch_data);

                let batch_data = new Object();
                batch_data.batch_id = row.batch_id;
                batch_data.batch_data = JSON.stringify(object);
                batchList.push(batch_data);
            })
            
            console.log(batchList , "batchList")
            
            callModifyBatchFunc(batchList , 'step');
        }

        function saveBatchData(){
        	
            const plate_id = getSelectedPlateId();
            const data = gridMap[plate_id].getData();
            let batchList = [];
            
            loadBatchData(plate_id,batchList);
            
            console.log(batchList , "batchList")
            
            callModifyBatchFunc(batchList , 'batch');
        }

        function loadBatchData(plate_id, batchList){
            let modifyedData = gridMap[plate_id].getModifiedRows().updatedRows;

            const stepData = [[${result.step}]];
            let flag = false;
            modifyedData.forEach(row => {
                let object = new Object();
                if(row.batch_data)
                    object = JSON.parse(row.batch_data);

                stepData.forEach(step =>{
                    if(row[step.step_id]) {
                        object[step.step_id] = row[step.step_id];
                    }
                })

                row.batch_data = JSON.stringify(object);
                gridMap[plate_id].setValue(row.rowKey, 'batch_data',row.batch_data);

                let batch_data = new Object();
                batch_data.batch_id = row.batch_id;
                batch_data.batch_data = JSON.stringify(object);
                batchList.push(batch_data);
            })
            return flag;
        }

        function checkAllState(){
            const dataList = document.querySelectorAll('.tui-grid-rside-area .tui-grid-cell-content');
            
            for (let i = 0; i < dataList.length; i++){
                if(dataList[i].innerText == ''){
                    return false;
                }
            }
            return true;
        }

        function saveAllData(){
            let batchList = [];
            let plateList = [];
            const plateEl = document.querySelectorAll('#plate_list .setting_top_list');
            
            plateEl.forEach(plate =>{
                const grid_id = plate.dataset.grid;
                plateList.push(grid_id);
                createGrid(grid_id);
                loadBatchData(grid_id, batchList);
            })
            
            callModifyBatchFunc(batchList , "all");
        }
        
        function ajaxSubStepSave(batch_list , step_id){
        	
        	$.ajax({
        		url : '/api/modify-substep',
                method : 'POST',
                data : {
                    'batchJson' : JSON.stringify(batch_list),
                    'step_id' : step_id
                },
                success : function(result){
                    if(result < 0 ){
                        getErrorMessage(result);
                    }
                    else{
                        alert("데이터를 수정하였습니다.")
                    }
                }
        	})
        }

        function callModifyBatchFunc(data , type){
        	
            const flag = checkAllState();
            const step = getSelectedStepData();
            const plan_step = step?.step ?? -1;

            const plate =  getSelectedPlateData();
            console.log(plate,"plate");
            const plan_plate = plate?.plate ?? -1;
            console.log(flag,"flag");

            $.ajax({
                url : '/api/modify-batch',
                method : 'POST',
                data : {
                    'batchJson' : JSON.stringify(data),
                    'plan_id' : [[${result.plan.plan_id}]],
                    'plan_code' : [[${result.plan.plan_code}]],
                    'state' : flag,
                    'plan_step' : plan_step,
                    'plan_plate' : plan_plate,
                    'division' : [[${result.plan.division_depth_3}]],
                    'type' : type
                },
                success : function(result){
                    if(result < 0 ){
                        getErrorMessage(result);
                    }else{
						switch (type){
							case 'step' : alert("데이터가 저장되었습니다.")
								break;
							case 'batch' : alert("배치가 저장되었습니다.")
								break;
							case 'all' : alert("전체완료 되었습니다.")
								break;
						}
                    }
                }

            })
        }

        function getSelectedStepData(){
            const selectedStep = document.querySelector('#step_list > .step_list.done');

            if(selectedStep){
                const step_data = Object.assign({}, selectedStep.dataset)
                console.log(step_data , "step_data");
                return step_data;
            }
            return null;
        }

        function getSelectedPlateId(){
            const selectedPlate = document.querySelector('#plate_list > .setting_top_list.active');
            if(!selectedPlate){
                return -1;
            }
            const grid_id = selectedPlate.dataset.grid;
            return grid_id;
        }

        function getSelectedPlateData(){
            const selectedPlate = document.querySelector('#plate_list > .setting_top_list.active');
            if(selectedPlate){
                const plate_data = Object.assign({}, selectedPlate.dataset);
                return plate_data;
            }

            return null;
        }



        async function exportExcel(ev,headerArr){
            console.table(ev);
            ev.exportFormat="xlsx";
            let batchList = [];
            let plateList = [];
            const plateEl = document.querySelectorAll('#plate_list .setting_top_list');

            for(let i = 0; i < plateEl.length; i++){
                const plate = plateEl[i];
                const grid_id = plate.dataset.grid;
                plateList.push(grid_id);

                const test = await createGrid(grid_id, "loadBatch");
                loadBatchData(grid_id, batchList);
            }

            let data = [];
            for(let key in gridMap){
                data = data.concat(gridMap[key].getData());
            }
            ev.data = data;
            for(let i = 1; i <= [[${result.plan.method_result}]]; i++){
                let header = createHeader1(`result${i}`,`result${i}`);
                headerArr.push(header);
            }

            if(!excelGrd) {
                excelGrd = new tui.Grid({
                    el: document.getElementById('excelGrid'),
                    scrollY: false,
                    scrollX: true,
                    data: data,
                    rowHeaders: ['rowNum'],
                    columns: headerArr,
                    columnOptions: {
                        frozenCount: 5,
                        frozenBorderWidth: 2,
                        minWidth: 200
                    }
                });
            }
            else{
                excelGrd.setColumns(headerArr);
                excelGrd.resetData(data);
            }
            const options = {
                fileName : [[${result.plan.plan_code}]] + '시료분석',
            }
            excelGrd.export('xlsx',options);
            ev.stop();
            console.table(ev.data);
        }

        let plan_step_id = -1;
        function getStepImage(step_id){
            $.ajax({
                url : '/api/step_image',
                method : 'GET',
                data : {
                    'step_id' : step_id,
                    'plan_id' : [[${result.plan.plan_id}]],
                },
                success : function(result){
                    console.log(" -------------- ")
                    console.log(step_id)
                    console.log(result,"result");
                    if(result.state < 0 ){
                        getErrorMessage(result.state);
                    }
                    else{
                        $('#_photoModal').addClass('on');
                        $('.photo_box').empty();
                        $('#main').addClass('modal_on');
                        plan_step_id = result.plan_step_id;
                        result.list.forEach(photo => {
                        	
                            modalImageArr.push({step_image_id: photo.step_image_id})
                        	
                            let li = `
                              <li class="photo_list new_data">
                                   <button type="button" class="common_btn1 modal_btn del_btn" onclick="deleteImage(${photo.step_image_id},${step_id},[[${result.plan.plan_id}]])" >x</button>
                                  <div class="photo_win">
                                        <img src="/${photo.atch_AT_CODE}"/>
                                   </div>
                                       <label htmlFor="">
                                    <textarea name="" id="" data-step=${photo.plan_step_id} data-image="${photo.step_image_id}">${photo.image_comment == null ? '' : photo.image_comment}</textarea>
                                 </label>
                                 
                                 <input type="hidden" name="step_image_id" value="${photo.step_image_id}">
                              </li>
                          `;
                            $ ('.photo_box').append(li);
                        })


                    }
                }

            })
        }

        let modalImageArr = [];
        const onChangeModalImage = e => {
            modalImageArr.push({img:e.files[0] , step_image_id: -1});
            const photo_box = document.querySelector(".photo_box");
            let currentHTML = photo_box.innerHTML
            currentHTML += `
                              <li class="photo_list new_data">
                                  <button type="button" class="common_btn1 modal_btn del_btn" onclick="onClickDeleteImg()" >x</button>
                                  <div class="photo_win">
                                        <img src="${URL.createObjectURL(e.files[0])}"/>
                                   </div>
                                       <label htmlFor="">
                                    <textarea name="" id=""></textarea>
                                 </label>
                                 
                                 <input type="hidden" name="step_image_id" value="-1">
                              </li>
            `;
            photo_box.innerHTML = currentHTML;
        }
        const onClickModalSave = () => {
            let formData = new FormData();

            const modalImgWrap = document.querySelector("#modalImgWrap");
            const textAreaEls = modalImgWrap.querySelectorAll(".new_data textarea");
            
            for(var i = 0 ; i < textAreaEls.length ; i++){
            	
                let comment = textAreaEls[i].value;
                let step_image_id = modalImageArr[i].step_image_id;
                
                if(step_image_id == -1){
	                formData.append(`stepImageList[${i}].img`, modalImageArr[i].img);
                }
                formData.append(`stepImageList[${i}].image_comment`, comment);
                formData.append(`stepImageList[${i}].plan_step_id`, plan_step_id);
                formData.append(`stepImageList[${i}].step_image_id`, step_image_id);
            }
            
            console.log(modalImageArr);
            
            $.ajax({
                url:'/api/step_image',
                type:"POST",
                enctype: 'multipart/form-data',
                processData: false,
                contentType: false,
                data:formData,
                success : function (data){
                    
                    if(data == 1){
                    	alert("사진이 등록되었습니다");
                    }
                    
                   	if(data == 0){
                   		alert("등록에 실패했습니다")
                   	}
                    
                    if(data == -1){
                    	alert("사진을 추가해주세요")
                    }
                    
                    if(data == -23){
						alert("이미지 파일이 존재하지 않습니다")                    	
                    }
                    
                }
            })
        }
        
        let subGrid = null;
        let subStep_id = -1;
        function getSubStepGrid(step_id){

            $.ajax({
                url : '/api/subStep',
                method : 'GET',
                data : {
                    'step_id' : step_id,
                    'plate_id' : sub_plate_id
                },
                success : function(result){
                	 
                	 $('#subStepGrid').children().remove();
                	 $('#_subStepModal').addClass('on');
                     $('#main').addClass('modal_on');
                	 
                	subGrid = new tui.Grid({
                        el : document.getElementById('subStepGrid'),
                        scrollY: true,
                        scrollX: true,
                        data: [],
                        rowHeaders: ['rowNum'],
                        editingEvent: 'click',
                        columns: [],
                        columnOptions: {
                            frozenCount: frozenCount,
                            frozenBorderWidth: 2,
                            minWidth: 100
                        },
                        bodyHeight: 400,
                       	pageOptions: {
                            useClient: true,
                            type: 'scroll',
                           	perPage : 20
                        },
                    });

                    let headerArr = createSubHeaderList(step_id);
                    
                    subGrid.setColumns(headerArr);
                    subGrid.resetData(result.list);
					
                    subStep_id = step_id;
                 }
            })
        }

        function deleteImage(image_id, step_id){
            $.ajax({
                url : "/api/delete_image",
                type:"POST",
                data : {
                    'step_image_id' : image_id,
                },
                success : function (result){
                    console.log(result);
                    getStepImage(step_id)
                }
            })
        }

        function onClickDelete (image_id){
            console.log(image_id)
        } 
        
        // 모달 창 닫기
       	$('.modal_close').on('click' , function(){
       		$('#main').removeClass('modal_on');
       		$('.harvesting_modal').removeClass('on');
       	}) 
    </script>
	<script>

    $('.download_btn').on('click', function(e){
        const grid_id = getSelectedPlateId();
        gridMap[grid_id].export('xlsx');
    })
    
    $('.step_list').on('click' , function(e){
    	
    	let step_id = e.target.dataset.step;
    	
    	$.ajax({
    		url : `/api/step/${step_id}`,
    		type : "GET",
    		success : function(data){
    			
    			let display = '';
    			
    			display += data.step_name;
    			
    			if(data.inputList.length >= 0){
    				
    				display += `[`;
    				for(let i of data.inputList){
    					
    					if(i.input != null && i.each != null){
	    					display += `${i.input} ${i.each},`
    					}
    				}
    				display += `]`;
    			} 
    			
    			$('.method_comment').text(display);
    		}
    	})
    	
    })

    </script>
</body>
</html>
